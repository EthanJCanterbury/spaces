{% extends "base.html" %}

{% block body_class %}editor-page{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/eclipse.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.min.css">

<link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/github.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/hackatime-badge.css') }}">

<style>
    /* File tabs styling */
    .file-tabs {
        display: flex;
        background-color: #f5f5f5;
        border-bottom: 1px solid #ddd;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .file-tab {
        padding: 8px 15px;
        cursor: pointer;
        border-right: 1px solid #ddd;
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        position: relative;
        background-color: #f5f5f5;
        transition: all 0.2s ease;
    }
    
    .file-tab.active {
        background-color: #fff;
        border-bottom: 2px solid #ec3750;
    }
    
    .file-tab:hover {
        background-color: #e9e9e9;
    }
    
    .file-tab i {
        margin-right: 5px;
        font-size: 0.9rem;
    }
    
    .file-tab .close-tab {
        margin-left: 8px;
        opacity: 0.5;
        transition: all 0.2s ease;
    }
    
    .file-tab .close-tab:hover {
        opacity: 1;
        color: #ec3750;
    }
    
    /* Console styling */
    .console-panel {
        background-color: #1e1e1e;
        color: #f8f8f8;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        padding: 15px;
        height: 100%;
        overflow: auto;
        white-space: pre-wrap;
        border-radius: 4px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        border: 1px solid #333;
    }
    
    .console-output {
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        line-height: 1.5;
        padding: 10px;
        background-color: #252526;
        border-radius: 4px;
    }
    
    .console-welcome {
        color: #8bc34a;
        margin-bottom: 15px;
        font-weight: bold;
    }
    
    .console-prompt {
        color: #64b5f6;
        margin-right: 8px;
        font-weight: bold;
    }
    
    .console-highlight {
        color: #ff9800;
        font-weight: bold;
    }
    
    .execution-info {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background-color: #252526;
        border-top: 1px solid #333;
        margin-top: 10px;
        border-radius: 0 0 4px 4px;
        font-size: 0.9rem;
    }
    
    .execution-time {
        color: #64b5f6;
    }
    
    .console-input {
        margin-top: 15px;
        display: flex;
        border-top: 1px solid #333;
        padding-top: 10px;
    }
    
    .console-input textarea {
        flex-grow: 1;
        background-color: #2d2d2d;
        color: #f8f8f8;
        border: 1px solid #3e3e3e;
        padding: 10px;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        border-radius: 4px;
        resize: vertical;
    }
    
    .language-badge {
        display: inline-flex;
        align-items: center;
        background-color: rgba(0, 120, 215, 0.15);
        color: #0078d7;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-left: 10px;
    }
    
    .language-badge i {
        margin-right: 5px;
    }
    
    .language-select {
        margin-left: 10px;
        padding: 4px 8px;
        border-radius: 4px;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
    }
    
    .run-options {
        display: flex;
        align-items: center;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    
    .run-options label {
        margin-right: 10px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .run-options input, .run-options textarea {
        margin-right: 20px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .execution-info {
        font-size: 0.8rem;
        color: #888;
        margin-top: 5px;
    }
    
    .execution-time {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-image-container">
            <img src="{{ url_for('static', filename='images/typingdino.gif') }}" alt="Loading..." class="loading-dino">
        </div>
        <div class="loading-text-container">
            <h2 class="loading-title">Building Your Space</h2>
            <p class="loading-text">Setting up your coding environment...</p>
        </div>
        <div class="loading-progress-container">
            <div class="loading-progress-bar">
                <div class="loading-progress-fill"></div>
            </div>
        </div>
    </div>
</div>

<div class="editor-container split-layout">
    <div class="editor-topbar">
        <div class="topbar-left">
            <a href="{{ url_for('welcome') }}" class="btn-icon" title="Back to Dashboard">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>{{ site.name }}</h1>
            <div class="language-badge">
                <i class="{{ language_icon }}"></i>
                <span>{{ site.language }}</span>
            </div>
            <select id="languageSelector" class="language-select" title="Change Language">
                <option value="{{ site.language }}" selected>{{ site.language }}</option>
                <!-- Additional languages will be loaded dynamically -->
            </select>
        </div>
        
        <div class="topbar-actions">
            <button id="undoBtn" class="btn-icon" title="Undo (Ctrl+Z)" disabled>
                <i class="fas fa-undo"></i>
            </button>
            <button id="redoBtn" class="btn-icon" title="Redo (Ctrl+Y)" disabled>
                <i class="fas fa-redo"></i>
            </button>

            <div class="dropdown">
                <button class="btn-icon dropdown-toggle" title="Editor Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <label for="themeSelector">Theme:</label>
                        <select id="themeSelector" onchange="changeEditorTheme(this.value)">
                            <option value="eclipse" selected>VS Code Light</option>
                            <option value="mdn-like">MDN-like</option>
                            <option value="solarized light">Solarized Light</option>
                        </select>
                    </div>
                    <div class="dropdown-section">
                        <label for="fontSizeSelector">Font Size:</label>
                        <select id="fontSizeSelector" onchange="changeEditorFontSize(this.value)">
                            <option value="12px">Small</option>
                            <option value="14px" selected>Medium</option>
                            <option value="16px">Large</option>
                            <option value="18px">X-Large</option>
                        </select>
                    </div>
                    <div class="dropdown-section checkbox">
                        <label>
                            <input type="checkbox" id="wordWrapToggle" checked onchange="toggleWordWrap(this.checked)">
                            Word Wrap
                        </label>
                    </div>
                    <div class="dropdown-section checkbox">
                        <label>
                            <input type="checkbox" id="lintToggle" onchange="toggleLinting(this.checked)">
                            Lint Code
                        </label>
                    </div>
                </div>
            </div>

            <button id="searchBtn" class="btn-icon" title="Search (Ctrl+F)" onclick="focusSearch()">
                <i class="fas fa-search"></i>
            </button>

            <button id="runBtn" class="btn-primary" onclick="runCode()">
                <i class="fas fa-play"></i>
                Run
            </button>
            
            <button id="formatterBtn" class="btn-primary" onclick="formatCode()">
                <i class="fas fa-magic"></i>
                Format
            </button>

            <button id="saveBtn" class="btn-primary" onclick="saveContent()">
                <i class="fas fa-save"></i>
                Save Changes
            </button>

            <button id="gitBtn" class="btn-primary" onclick="GitHubManager.openModal()" style="background: linear-gradient(135deg, #fa8072 0%, #e57363 100%);">
                <i class="fab fa-github"></i>
                Git
            </button>
        </div>
    </div>
    
    <div class="editor-main">
        <div class="editor-pane">
            <input type="hidden" id="site-slug" value="{{ site.slug }}">
            <input type="hidden" id="site-id" value="{{ site.id }}">
            <input type="hidden" id="site-type" value="{{ site.site_type }}">
            <input type="hidden" id="site-language" value="{{ site.language }}">
            <input type="hidden" id="site-language-version" value="{{ site.language_version }}">
            
            <div class="file-tabs">
                <div class="file-tab active">
                    <i class="fas fa-code"></i>
                    <span>{{ site.slug }}.{{ site.language }}</span>
                </div>
                <div class="file-tab" id="add-file-tab">
                    <i class="fas fa-plus"></i>
                    <span>Add File</span>
                </div>
            </div>
            
            <div id="editor-container" class="editor-container-inner">
                <textarea id="code-editor">{{ site.language_content }}</textarea>
            </div>
        </div>
        
        <div class="preview-pane">
            <div class="preview-header">
                <h3>Console</h3>
                <div class="preview-actions">
                    <button id="clearConsoleBtn" class="btn-icon" title="Clear Console" onclick="clearConsole()">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button id="copyOutputBtn" class="btn-icon" title="Copy Output" onclick="copyConsoleOutput()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div class="run-options">
                <label for="stdinInput">Standard Input:</label>
                <textarea id="stdinInput" rows="1" placeholder="Input for your program..."></textarea>
                
                <label for="argsInput">Command Line Args:</label>
                <input type="text" id="argsInput" placeholder="arg1 arg2 arg3">
            </div>
            
            <div class="console-panel">
                <div id="console-output" class="console-output">
                    <!-- Console output will be displayed here -->
                    <div class="console-welcome">
                        <p><span class="console-prompt">></span> Welcome to the <span class="console-highlight">{{ site.language }}</span> console!</p>
                        <p><span class="console-prompt">></span> Click the Run button to execute your code.</p>
                    </div>
                </div>
                <div class="execution-info">
                    <span><i class="fas fa-code"></i> Language: <strong class="language-badge">{{ site.language }} {{ site.language_version }}</strong></span>
                    <span class="execution-time" id="execution-time"><i class="fas fa-clock"></i> <span id="time-value">0.00s</span></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GitHub Integration Modal -->
<div id="github-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>GitHub Integration</h2>
            <span class="close-btn" onclick="GitHubManager.closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="github-status-container">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Checking GitHub status...
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/ruby/ruby.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/php/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>

<script src="{{ url_for('static', filename='js/github-integration.js') }}"></script>
<script src="{{ url_for('static', filename='js/hackatime-tracker.js') }}"></script>
<script src="{{ url_for('static', filename='js/code-editor.js') }}"></script>

<script>
    // Get the language from the hidden input
    const language = document.getElementById('site-language').value;
    
    // Map language names to CodeMirror modes
    const languageModes = {
        'python': 'python',
        'javascript': 'javascript',
        'typescript': 'javascript',
        'java': 'text/x-java',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'csharp': 'text/x-csharp',
        'go': 'go',
        'ruby': 'ruby',
        'rust': 'text/x-rustsrc',
        'php': 'php',
        'swift': 'text/x-swift',
        'kotlin': 'text/x-kotlin',
        'bash': 'shell'
    };
    
    // Debug language detection
    console.log('Language detected:', language);
    console.log('Mode selected:', languageModes[language] || 'text/plain');
    
    // Initialize CodeMirror with the appropriate mode
    const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: languageModes[language] || 'text/plain',
        theme: 'eclipse',
        lineNumbers: true,
        indentUnit: 4,
        matchBrackets: true,
        autoCloseBrackets: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        styleActiveLine: true,
        lineWrapping: true,
        extraKeys: {
            "Ctrl-Space": "autocomplete",
            "Ctrl-S": function(cm) { saveContent(); },
            "Cmd-S": function(cm) { saveContent(); },
            "F11": function(cm) { toggleFullScreen(cm); },
            "Esc": function(cm) { if (isFullScreen) toggleFullScreen(cm); }
        }
    });
    
    // Set up editor events
    editor.on('change', function() {
        document.getElementById('undoBtn').disabled = !editor.historySize().undo;
        document.getElementById('redoBtn').disabled = !editor.historySize().redo;
    });
    
    // Initialize UI elements
    document.getElementById('undoBtn').addEventListener('click', function() { editor.undo(); });
    document.getElementById('redoBtn').addEventListener('click', function() { editor.redo(); });
    
    // Load languages for the language selector
    async function loadLanguages() {
        try {
            const response = await fetch('/api/languages');
            if (response.ok) {
                const data = await response.json();
                const languageSelector = document.getElementById('languageSelector');
                
                // Clear existing options
                languageSelector.innerHTML = '';
                
                // Add options for each language
                data.languages.forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang.name;
                    option.textContent = lang.display_name;
                    if (lang.name === language) {
                        option.selected = true;
                    }
                    languageSelector.appendChild(option);
                });
                
                // Add change event listener
                languageSelector.addEventListener('change', changeLanguage);
            }
        } catch (error) {
            console.error('Error loading languages:', error);
        }
    }
    
    // Change the language of the editor
    async function changeLanguage(event) {
        const newLanguage = event.target.value;
        const currentLanguage = document.getElementById('site-language').value;
        
        if (newLanguage === currentLanguage) {
            return;
        }
        
        // Confirm language change
        if (!confirm(`Are you sure you want to change the language to ${newLanguage}? This will update the code template and may result in loss of your current code.`)) {
            // Reset the selector to the current language
            event.target.value = currentLanguage;
            return;
        }
        
        try {
            // Save the current content with the new language
            await saveContent(newLanguage);
            
            // Reload the page to apply the new language
            window.location.reload();
        } catch (error) {
            console.error('Error changing language:', error);
            showToast('error', 'Failed to change language');
            
            // Reset the selector to the current language
            event.target.value = currentLanguage;
        }
    }
    
    // Run the code
    async function runCode() {
        const runBtn = document.getElementById('runBtn');
        const consoleOutput = document.getElementById('console-output');
        const executionTime = document.getElementById('execution-time');
        const siteId = document.getElementById('site-id').value;
        const code = editor.getValue();
        const stdin = document.getElementById('stdinInput').value;
        const argsInput = document.getElementById('argsInput').value;
        const args = argsInput ? argsInput.split(' ') : [];
        
        // Disable run button and show loading state
        runBtn.disabled = true;
        runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
        
        // Clear previous execution time
        executionTime.textContent = '';
        
        // Show "Running..." in console
        consoleOutput.innerHTML = '<div class="console-running">Running code...</div>';
        
        try {
            const response = await fetch(`/api/sites/${siteId}/run`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code, stdin, args })
            });
            
            const result = await response.json();
            
            // Format and display the output
            let outputHtml = '';
            
            if (result.error) {
                outputHtml = `<div class="console-error">${escapeHtml(result.output)}</div>`;
            } else {
                outputHtml = `<div class="console-success">${escapeHtml(result.output)}</div>`;
                
                // Show execution time if available
                if (result.execution_time) {
                    executionTime.textContent = `Execution time: ${result.execution_time}ms`;
                }
            }
            
            consoleOutput.innerHTML = outputHtml;
            
            // Scroll to the bottom of the console
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        } catch (error) {
            console.error('Error running code:', error);
            consoleOutput.innerHTML = `<div class="console-error">Error: Failed to run code. Please try again.</div>`;
        } finally {
            // Re-enable run button
            runBtn.disabled = false;
            runBtn.innerHTML = '<i class="fas fa-play"></i> Run';
        }
    }
    
    // Clear the console output
    function clearConsole() {
        document.getElementById('console-output').innerHTML = '';
        document.getElementById('execution-time').textContent = '';
    }
    
    // Copy console output to clipboard
    function copyConsoleOutput() {
        const consoleOutput = document.getElementById('console-output').innerText;
        navigator.clipboard.writeText(consoleOutput)
            .then(() => showToast('success', 'Console output copied to clipboard'))
            .catch(err => showToast('error', 'Failed to copy console output'));
    }
    
    // Save the content
    async function saveContent(newLanguage = null) {
        const saveBtn = document.getElementById('saveBtn');
        const siteId = document.getElementById('site-id').value;
        const content = editor.getValue();
        
        // Disable save button and show loading state
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        try {
            const requestData = { content };
            
            // If changing language, include it in the request
            if (newLanguage) {
                requestData.language = newLanguage;
            }
            
            const response = await fetch(`/api/site/${siteId}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast('success', 'Code saved successfully');
                
                // Update language if it was changed
                if (newLanguage) {
                    document.getElementById('site-language').value = newLanguage;
                }
            } else {
                showToast('error', result.message || 'Failed to save code');
            }
        } catch (error) {
            console.error('Error saving code:', error);
            showToast('error', 'Failed to save code');
        } finally {
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }
    }
    
    // Format the code
    function formatCode() {
        // This is a placeholder for code formatting functionality
        // In a real implementation, you would use a formatter appropriate for the language
        showToast('info', 'Code formatting is not available for this language');
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            .replace(/\n/g, '<br>')
            .replace(/\s{2}/g, '&nbsp;&nbsp;');
    }
    
    // Show a toast message
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        const container = document.getElementById('toast-container') || createToastContainer();
        container.appendChild(toast);
        
        // Trigger reflow to enable animation
        toast.offsetHeight;
        toast.classList.add('show');
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }
    
    // Create toast container if it doesn't exist
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        document.body.appendChild(container);
        return container;
    }
    
    // Change editor theme
    function changeEditorTheme(theme) {
        const currentTheme = editor.getOption('theme');
        if (currentTheme) {
            editor.getWrapperElement().classList.remove('cm-s-' + currentTheme);
        }
        editor.setOption('theme', theme);
        localStorage.setItem('editor-theme', theme);
    }
    
    // Change editor font size
    function changeEditorFontSize(size) {
        editor.getWrapperElement().style.fontSize = size;
        localStorage.setItem('editor-font-size', size);
    }
    
    // Toggle word wrap
    function toggleWordWrap(enabled) {
        editor.setOption('lineWrapping', enabled);
        localStorage.setItem('editor-word-wrap', enabled ? 'true' : 'false');
    }
    
    // Toggle linting
    function toggleLinting(enabled) {
        // This is a placeholder for linting functionality
        showToast('info', `Linting ${enabled ? 'enabled' : 'disabled'}`);
        localStorage.setItem('editor-lint', enabled ? 'true' : 'false');
    }
    
    // Focus search
    function focusSearch() {
        CodeMirror.commands.find(editor);
    }
    
    // Initialize the editor with saved settings
    function initializeEditorSettings() {
        const theme = localStorage.getItem('editor-theme') || 'eclipse';
        const fontSize = localStorage.getItem('editor-font-size') || '14px';
        const wordWrap = localStorage.getItem('editor-word-wrap') !== 'false';
        const lint = localStorage.getItem('editor-lint') === 'true';
        
        // Apply settings
        document.getElementById('themeSelector').value = theme;
        document.getElementById('fontSizeSelector').value = fontSize;
        document.getElementById('wordWrapToggle').checked = wordWrap;
        document.getElementById('lintToggle').checked = lint;
        
        changeEditorTheme(theme);
        changeEditorFontSize(fontSize);
        toggleWordWrap(wordWrap);
    }
    
    // Initialize when the document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Hide loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        
        // Initialize editor settings
        initializeEditorSettings();
        
        // Load languages
        loadLanguages();
        
        // Initialize GitHub integration
        if (typeof GitHubManager !== 'undefined') {
            GitHubManager.init();
        }
        
        // Initialize HackaTime tracker
        if (typeof HackaTimeTracker !== 'undefined') {
            HackaTimeTracker.init();
        }
    });
</script>

{% if additional_scripts %}
{{ additional_scripts|safe }}
{% endif %}
{% endblock %}
