{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <div class="admin-sidebar">
        <div class="admin-profile">
            <div class="profile-avatar">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="profile-info">
                <h3>{{ current_user.username }}</h3>
                <span class="admin-badge">Full-Administrator</span>
            </div>
        </div>

        <nav class="admin-nav">
            <ul>
                <li>
                    <a href="#dashboard" class="nav-link active" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#users" class="nav-link" data-section="users">
                        <i class="fas fa-users"></i>
                        <span>Users</span>
                    </a>
                </li>
                <li>
                    <a href="#sites" class="nav-link" data-section="sites">
                        <i class="fas fa-globe"></i>
                        <span>Sites</span>
                    </a>
                </li>
                <li>
                    <a href="#admins" class="nav-link" data-section="admins">
                        <i class="fas fa-user-cog"></i>
                        <span>Admins</span>
                    </a>
                </li>
                <li>
                    <a href="#analytics" class="nav-link" data-section="analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                    </a>
                </li>
                <li>
                    <a href="#clubs" class="nav-link" data-section="clubs">
                        <i class="fas fa-users"></i>
                        <span>Clubs</span>
                    </a>
                </li>
                <li>
                    <a href="#settings" class="nav-link" data-section="settings">
                        <i class="fas fa-cogs"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <div class="admin-sidebar-footer">
            <div class="sidebar-collapse-btn" id="sidebarCollapseBtn">
                <i class="fas fa-chevron-left"></i>
            </div>
            <a href="/logout" class="logout-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <div class="admin-content">
        <div class="admin-header">
            <h1><i class="fas fa-shield-alt"></i> Hack Club HQ | Panel for Spaces Admins</h1>
            <div class="header-actions">
                <button class="btn-primary email-btn" onclick="emailAllUsers()">
                    <i class="fas fa-envelope"></i> Email All Users
                </button>
                <button class="btn-success refresh-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>

        <section id="dashboard" class="admin-section active">
            <div class="section-header">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <p>Overview of Hack Club Space's performance and statistics YAY!!!</p>
                <p>This is a very early version of this dash since I like just made it. ~ Ethan</p>
            </div>

            <div class="dashboard-stats">
                <div class="stats-wrapper">
                    <div class="stat-card">
                        <div class="stat-icon user-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalUsers">Loading...</h3>
                            <p>Total Users</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon user-icon">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalSites">Loading...</h3>
                            <p>Total Sites</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon admin-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="adminCount">Loading...</h3>
                            <p>Admins</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard-row">
                <div class="dashboard-card recent-activity">
                    <div class="card-header">
                        <h3><i class="fas fa-history"></i> Recent Activity</h3>
                    </div>
                    <div class="card-content">
                        <ul class="activity-list" id="recentActivitiesList">
                            <li class="activity-item activity-loading">
                                <div class="loading-spinner"></div>
                                <span>Loading recent activities...</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="dashboard-card system-status">
                    <div class="card-header">
                        <h3><i class="fas fa-server"></i> System Status</h3>
                    </div>
                    <div class="card-content">
                        <div class="status-item">
                            <span class="status-label">Server Status</span>
                            <span id="serverStatus" class="status-value">Checking... <i class="fas fa-spinner fa-spin"></i></span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Database</span>
                            <span id="databaseStatus" class="status-value">Checking... <i class="fas fa-spinner fa-spin"></i></span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Last Backup</span>
                            <span id="lastBackup" class="status-value">Checking... <i class="fas fa-spinner fa-spin"></i></span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Version</span>
                            <span class="status-value">{{ version }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="users" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Users Management</h2>
                <p>View and manage user accounts (showing first 10 users)</p>
                <p class="text-muted">Use the search box below to find specific users</p>
            </div>

            <div class="section-actions">
                <div class="search-container">
                    <input type="text" id="userSearch" class="search-input" placeholder="Search users (min 2 chars)..." oninput="filterUsers()">
                    <i class="fas fa-search"></i>
                </div>

                <div class="bulk-actions">
                    <button class="btn-warning bulk-action" onclick="handleBulkAction('suspend')" disabled>
                        <i class="fas fa-user-lock"></i> Suspend Selected
                    </button>
                    <button class="btn-warning bulk-action" onclick="handleBulkAction('unsuspend')" disabled>
                        <i class="fas fa-user-check"></i> Unsuspend Selected
                    </button>
                    <button class="btn-danger bulk-action" onclick="handleBulkAction('deleteSites')" disabled>
                        <i class="fas fa-trash-alt"></i> Delete Sites
                    </button>
                    <button class="btn-danger bulk-action" onclick="handleBulkAction('deleteUsers')" disabled>
                        <i class="fas fa-user-times"></i> Delete Users
                    </button>
                    <button class="btn-primary bulk-action" onclick="exportUserData()" title="Export selected users data to CSV">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                </div>
            </div>

            <div class="dashboard-stats user-management-stats">
                <div class="stat-card">
                    <div class="stat-icon user-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="newUsersCount">0</h3>
                        <p>New users (last 7 days)</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon site-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Active users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon admin-icon">
                        <i class="fas fa-user-times"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="suspendedUsers">0</h3>
                        <p>Suspended users</p>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Created At</th>
                            <th>Last Login</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        {% for user in users %}
                        <tr>
                            <td>
                                {% if user.id != current_user.id %}
                                <input type="checkbox" class="user-select" data-userid="{{ user.id }}" data-username="{{ user.username }}" onchange="updateBulkActions()">
                                {% endif %}
                            </td>
                            <td>{{ user.id }}</td>
                            <td>
                                <div class="user-table-info">
                                    <div class="user-avatar-small">
                                        {% if user.avatar %}
                                        <img src="{{ user.avatar }}" alt="{{ user.username }}">
                                        {% else %}
                                        <i class="fas fa-user"></i>
                                        {% endif %}
                                    </div>
                                    {{ user.username }}
                                </div>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else 'Never' }}</td>
                            <td>
                                <span class="status-badge {{ 'suspended' if user.is_suspended else 'active' }}">
                                    {{ 'Suspended' if user.is_suspended else 'Active' }}
                                </span>
                                <span class="status-badge club-leader" id="club-leader-badge-{{ user.id }}" style="display: {% if Club.query.filter_by(leader_id=user.id).first() %}inline-block{% else %}none{% endif %}">
                                    Club Leader
                                </span>
                                {% if user.is_admin %}
                                <span class="status-badge admin">
                                    Admin
                                </span>
                                {% endif %}
                                {% if user.is_staff %}
                                <span class="status-badge staff-badge">
                                    HQ Staff
                                </span>
                                {% endif %}
                                {% if user.is_profile_public %}
                                <span class="status-badge public-profile">
                                    Public Profile
                                </span>
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                <div class="action-dropdown">
                                    <button class="action-dropdown-btn" onclick="toggleActionDropdown(this)">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="action-dropdown-content">
                                        <button onclick="viewUserDetails({{ user.id }})" class="dropdown-item">
                                            <i class="fas fa-eye"></i>
                                            <span>View Details</span>
                                        </button>
                                        <button onclick="editUserProfile({{ user.id }})" class="dropdown-item">
                                            <i class="fas fa-user-edit"></i>
                                            <span>Edit Profile</span>
                                        </button>
                                        {% if user.is_profile_public %}
                                        <a href="/p/{{ user.username }}" target="_blank" class="dropdown-item">
                                            <i class="fas fa-external-link-alt"></i>
                                            <span>View Public Profile</span>
                                        </a>
                                        {% endif %}
                                        {% if user.id != current_user.id %}
                                        <button onclick="impersonateUser({{ user.id }}, '{{ user.username }}')" class="dropdown-item">
                                            <i class="fas fa-user-secret"></i>
                                            <span>Impersonate User</span>
                                        </button>
                                        <button onclick="toggleSuspension({{ user.id }}, '{{ user.username }}', {{ 'false' if user.is_suspended else 'true' }})" class="dropdown-item">
                                            <i class="fas fa-{{ 'user-check' if user.is_suspended else 'user-lock' }}"></i>
                                            <span>{{ 'Unsuspend' if user.is_suspended else 'Suspend' }}</span>
                                        </button>
                                        <button class="dropdown-item" onclick="toggleClubLeader({{ user.id }}, '{{ user.username }}', {{ 'true' if Club.query.filter_by(leader_id=user.id).first() else 'false' }})">
                                            <i class="fas fa-user-tag"></i>
                                            <span>{{ 'Remove Club Leader Role' if Club.query.filter_by(leader_id=user.id).first() else 'Grant Club Leader Role' }}</span>
                                        </button>
                                        <button onclick="toggleAdminStatus({{ user.id }}, '{{ user.username }}', {{ 'false' if user.is_admin else 'true' }})" class="dropdown-item">
                                            <i class="fas fa-{{ 'user-minus' if user.is_admin else 'user-shield' }}"></i>
                                            <span>{{ 'Remove Admin' if user.is_admin else 'Make Admin' }}</span>
                                        </button>
                                        <button onclick="toggleStaffStatus({{ user.id }}, '{{ user.username }}', {{ 'false' if user.is_staff else 'true' }})" class="dropdown-item">
                                            <i class="fas fa-{{ 'user-minus' if user.is_staff else 'briefcase' }}"></i>
                                            <span>{{ 'Remove Staff' if user.is_staff else 'Make Staff' }}</span>
                                        </button>
                                        <button onclick="resetUserPassword({{ user.id }}, '{{ user.username }}')" class="dropdown-item">
                                            <i class="fas fa-key"></i>
                                            <span>Reset Password</span>
                                        </button>
                                        <button onclick="deleteAllSites({{ user.id }}, '{{ user.username }}')" class="dropdown-item">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Delete All Sites</span>
                                        </button>
                                        <button onclick="deleteUser({{ user.id }}, '{{ user.username }}')" class="dropdown-item text-danger">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Delete User</span>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button class="btn-page"><i class="fas fa-chevron-left"></i></button>
                <button class="btn-page active">1</button>
                <button class="btn-page">2</button>
                <button class="btn-page">3</button>
                <span class="pagination-ellipsis">...</span>
                <button class="btn-page">10</button>
                <button class="btn-page"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section id="sites" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-globe"></i> Sites Management</h2>
                <p>Monitor sites created by users (showing first 10 sites)</p>
                <p class="text-muted">Use the search box below to find specific sites</p>
            </div>

            <div class="section-actions">
                <div class="search-container">
                    <input type="text" id="siteSearch" class="search-input" placeholder="Search sites (min 2 chars)..." oninput="filterSites()">
                    <i class="fas fa-search"></i>
                </div>

                <div class="filter-dropdown">
                    <button class="btn-secondary filter-btn">
                        <i class="fas fa-filter"></i> Filter
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="filter-menu">
                        <div class="filter-option">
                            <input type="checkbox" id="filterWeb" checked>
                            <label for="filterWeb">Web Sites</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="filterPython" checked>
                            <label for="filterPython">Python Sites</label>
                        </div>
                        <div class="filter-option">
                            <input type="checkbox" id="filterRecent">
                            <label for="filterRecent">Recently Updated</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Owner</th>
                            <th>Type</th>
                            <th>Created At</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="siteTableBody">
                        {% for site in sites %}
                        <tr>
                            <td>{{ site.id }}</td>
                            <td>
                                <div class="site-name">
                                    <span class="site-icon">
                                        <i class="fas fa-{{ 'globe' if site.site_type == 'web' else 'code' }}"></i>
                                    </span>
                                    {{ site.name }}
                                </div>
                            </td>
                            <td>{{ site.username }}</td>
                            <td>
                                <span class="type-badge {{ site.site_type }}">
                                    {{ site.site_type|capitalize }}
                                </span>
                            </td>
                            <td>{{ site.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>{{ site.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="actions-cell">
                                <div class="action-dropdown">
                                    <button class="action-dropdown-btn" onclick="toggleActionDropdown(this)">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="action-dropdown-content">
                                        <a href="/s/{{ site.slug }}" target="_blank" class="dropdown-item">
                                            <i class="fas fa-eye"></i>
                                            <span>View Site</span>
                                        </a>
                                        <a href="/edit/{{ site.id }}" class="dropdown-item">
                                            <i class="fas fa-pencil-alt"></i>
                                            <span>Edit Site</span>
                                        </a>
                                        <button onclick="deleteSite({{ site.id }}, '{{ site.name }}')" class="dropdown-item text-danger">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Delete Site</span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button class="btn-page"><i class="fas fa-chevron-left"></i></button>
                <button class="btn-page active">1</button>
                <button class="btn-page">2</button>
                <button class="btn-page">3</button>
                <span class="pagination-ellipsis">...</span>
                <button class="btn-page">10</button>
                <button class="btn-page"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section id="admins" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-user-shield"></i> Admin Management</h2>
                <p>Manage administrator accounts and permissions (stop removing Ethan's admin ):<)</p>
            </div>

            <div class="admin-management">
                <div class="admin-list-container">
                    <div class="card-header">
                        <h3><i class="fas fa-users-cog"></i> Current Administrators</h3>
                    </div>
                    <ul id="adminList" class="admin-list">
                        <li class="admin-list-loading">
                            <div class="loading-spinner"></div>
                            <span>Loading admins...</span>
                        </li>
                    </ul>
                </div>

                <div class="add-admin-form">
                    <div class="card-header">
                        <h3><i class="fas fa-user-plus"></i> Add New Administrator</h3>
                    </div>
                    <div class="form-content">
                        <p>Grant administrator privileges to an existing user account</p>
                        <div class="form-group">
                            <label for="newAdminUsername">
                                <i class="fas fa-user"></i>
                                Username
                            </label>
                            <div class="input-with-icon">
                                <input type="text" id="newAdminUsername" placeholder="Enter username" class="admin-input">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <button onclick="addAdmin()" class="btn-primary add-admin-btn">
                            <i class="fas fa-plus"></i> Add as Administrator
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="clubs" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Clubs Management</h2>
                <p>Manage clubs and their members</p>
                <p class="text-muted">Use the search box below to find specific clubs</p>
            </div>

            <div class="section-actions">
                <div class="search-container">
                    <input type="text" id="clubSearch" class="search-input" placeholder="Search clubs (min 2 chars)..." oninput="filterClubs()">
                    <i class="fas fa-search"></i>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Leader</th>
                            <th>Members</th>
                            <th>Balance</th>
                            <th>Created At</th>
                            <th>Join Code</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clubTableBody">
                        {% for club in clubs %}
                        <tr>
                            <td>{{ club.id }}</td>
                            <td>{{ club.name }}</td>
                            <td>{{ club.leader.username }}</td>
                            <td>{{ club.members|length }}</td>
                            <td>
                                <span class="balance-amount" id="balance-{{ club.id }}">${{ "%.2f"|format(club.balance|float) }}</span>
                                <button class="btn-edit-balance" onclick="editClubBalance({{ club.id }}, {{ club.balance|float }})" title="Edit Balance">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                            <td>{{ club.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>{{ club.join_code }}</td>
                            <td class="actions-cell">
                                <div class="action-dropdown">
                                    <button class="action-dropdown-btn" onclick="toggleActionDropdown(this)">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="action-dropdown-content">
                                        <button onclick="viewClubDetails({{ club.id }})" class="dropdown-item">
                                            <i class="fas fa-eye"></i>
                                            <span>View Details</span>
                                        </button>
                                        <button onclick="resetJoinCode({{ club.id }})" class="dropdown-item">
                                            <i class="fas fa-key"></i>
                                            <span>Reset Join Code</span>
                                        </button>
                                        <button onclick="deleteClub({{ club.id }}, '{{ club.name }}')" class="dropdown-item text-danger">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Delete Club</span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="pagination">
                <button class="btn-page"><i class="fas fa-chevron-left"></i></button>
                <button class="btn-page active">1</button>
                <button class="btn-page">2</button>
                <button class="btn-page">3</button>
                <span class="pagination-ellipsis">...</span>
                <button class="btn-page">10</button>
                <button class="btn-page"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section id="analytics" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Analytics</h2>
                <p>nerdy analytic stuff lol</p>
            </div>

            <div class="analytics-timeframe">
                <button class="time-btn active" data-period="day" onclick="updateAnalytics('day')">Day</button>
                <button class="time-btn" data-period="week" onclick="updateAnalytics('week')">Week</button>
                <button class="time-btn" data-period="month" onclick="updateAnalytics('month')">Month</button>
                <button class="time-btn" data-period="year" onclick="updateAnalytics('year')">Year</button>
                <div class="date-picker">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Custom Range</span>
                </div>
            </div>

            <div class="analytics-grid">
                <div class="analytics-card wide">
                    <div class="card-header">
                        <h3>User Registrations</h3>
                        <div class="card-actions">
                            <button class="btn-icon" onclick="exportChart('userRegistrations')"><i class="fas fa-download"></i></button>
                            <button class="btn-icon"><i class="fas fa-ellipsis-v"></i></button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div id="userRegistrationsChart" class="chart-placeholder">
                            <div class="loading-spinner"></div>
                            <p>Loading chart data...</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Site Types</h3>
                        <div class="card-actions">
                            <button class="btn-icon" onclick="exportChart('siteTypes')"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div id="siteTypesChart" class="chart-placeholder">
                            <div class="loading-spinner"></div>
                            <p>Loading chart data...</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Traffic Sources</h3>
                        <div class="card-actions">
                            <button class="btn-icon" onclick="exportChart('trafficSources')"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div id="trafficSourcesChart" class="chart-placeholder">
                            <div class="loading-spinner"></div>
                            <p>Loading chart data...</p>
                        </div>
                    </div>
                </div>

                <div class="analytics-card wide">
                    <div class="card-header">
                        <h3>Platform Usage</h3>
                        <div class="card-actions">
                            <button class="btn-icon" onclick="exportChart('platformUsage')"><i class="fas fa-download"></i></button>
                            <button class="btn-icon"><i class="fas fa-ellipsis-v"></i></button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div id="platformUsageChart" class="chart-placeholder">
                            <div class="loading-spinner"></div>
                            <p>Loading chart data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="settings" class="admin-section">
            <div class="section-header">
                <h2><i class="fas fa-cogs"></i> Admin Settings</h2>
                <p>Configure platform settings and preferences</p>
                <div class="section-actions" style="margin-top: 15px;">
                    <a href="/api/admin/logs" class="btn-primary" download>
                        <i class="fas fa-download"></i> Download System Logs
                    </a>
                    <button onclick="clearSystemLogs()" class="btn-warning">
                        <i class="fas fa-trash-alt"></i> Clear System Logs
                    </button>
                </div>
            </div>

            <div class="settings-container">
                <div class="settings-card">
                    <div class="card-header">
                        <h3><i class="fas fa-user-friends"></i> Site Limit Settings</h3>
                    </div>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>User Limits</label>
                            <div class="input-group">
                                <span class="input-label">Max Sites Per User</span>
                                <input type="number" id="maxSitesPerUser" value="0.0" min="1" max="100" class="number-input">
                            </div>
                        </div>

                        <button class="btn-primary" onclick="saveMaxSitesPerUser()">Save Site Limit</button>
                        
                        <hr style="margin: 1.5rem 0;">
                        
                        <div class="form-group">
                            <label>Leader Onboarding</label>
                            <p class="text-muted">Access code required for club leader onboarding</p>
                            <div class="input-group">
                                <span class="input-label">Access Code</span>
                                <input type="text" id="leaderAccessCode" placeholder="Access code" class="settings-input">
                            </div>
                        </div>
                        
                        <button class="btn-primary" onclick="saveLeaderAccessCode()">Update Access Code</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="clubDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> Club Details</h2>
                <button class="close-btn" onclick="closeClubDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="club-info-container">
                    <div class="club-details" id="clubDetailContent">
                        <div class="club-detail-loading">
                            <div class="loading-spinner"></div>
                            <p>Loading club details...</p>
                        </div>
                    </div>
                </div>

                <div class="club-members-container">
                    <h3><i class="fas fa-user-friends"></i> Club Members</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Joined At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clubMembersTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="loading-spinner"></div>
                                        <p>Loading members...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeClubDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="userDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user"></i> User Details</h2>
                <button class="close-btn" onclick="closeUserDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-info-container">
                    <div class="user-avatar">
                        <img id="userAvatarPreview" src="" alt="User Avatar" onerror="this.src=''; this.onerror=null; this.parentNode.innerHTML = '<i class=\'fas fa-user-circle\'></i>'">
                    </div>
                    <div id="userDetailContent" class="user-details">
                    </div>
                </div>
                <div class="user-edit-container">
                    <h3><i class="fas fa-user-edit"></i> Edit User</h3>
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="form-group">
                            <label for="editUsername">Username</label>
                            <input type="text" id="editUsername" class="settings-input">
                        </div>
                        <div class="form-group">
                            <label for="editEmail">Email</label>
                            <input type="email" id="editEmail" class="settings-input">
                        </div>
                        <div class="form-group">
                            <label for="resetPassword">New Password</label>
                            <div class="password-input-group">
                                <input type="password" id="resetPassword" class="settings-input" placeholder="Leave blank to keep current password">
                                <button type="button" class="btn-icon toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-switch">
                            <input type="checkbox" id="editIsPublicProfile" class="toggle-switch">
                            <label for="editIsPublicProfile">Public Profile</label>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeUserDetailModal()">Close</button>
                <button class="btn-primary" onclick="saveUserChanges()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <div id="userProfileModal" class="modal">
        <div class="modal-content wide-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Edit User Profile</h2>
                <button class="close-btn" onclick="closeUserProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-edit-grid">
                    <div class="profile-edit-col">
                        <form id="profileEditForm">
                            <input type="hidden" id="profileUserId">
                            <div class="form-group">
                                <label for="profileUsername"><i class="fas fa-user"></i> Username</label>
                                <input type="text" id="profileUsername" class="settings-input" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profileEmail"><i class="fas fa-envelope"></i> Email</label>
                                <input type="email" id="profileEmail" class="settings-input" readonly>
                            </div>
                            <div class="form-group">
                                <label for="profileBio"><i class="fas fa-comment-alt"></i> Bio</label>
                                <textarea id="profileBio" class="settings-input" rows="4"></textarea>
                                <small>Tell others about this user</small>
                            </div>
                            <div class="form-group">
                                <label for="profileAvatar"><i class="fas fa-image"></i> Avatar URL</label>
                                <input type="url" id="profileAvatar" class="settings-input" placeholder="https://example.com/avatar.jpg">
                                <small>Provide a URL to an image file (JPG, PNG, GIF)</small>
                            </div>
                            <div class="form-group">
                                <label for="profileBanner"><i class="fas fa-image"></i> Profile Banner URL</label>
                                <input type="url" id="profileBanner" class="settings-input" placeholder="https://example.com/banner.jpg">
                                <small>Provide a URL to an image file for the profile banner</small>
                            </div>
                            <div class="form-switch">
                                <input type="checkbox" id="profileIsPublic" class="toggle-switch">
                                <label for="profileIsPublic">Public Profile</label>
                                <small>If enabled, user's profile will be publicly visible</small>
                            </div>
                        </form>
                    </div>
                    <div class="profile-edit-col">
                        <div class="profile-preview">
                            <h3><i class="fas fa-eye"></i> Profile Preview</h3>
                            <div class="profile-preview-card">
                                <div class="preview-banner" id="previewBanner">
                                    <div class="preview-avatar" id="previewAvatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div class="preview-content">
                                    <h3 id="previewUsername">Username</h3>
                                    <p id="previewBio">User bio will appear here...</p>
                                </div>
                            </div>
                        </div>

                        <div class="social-links-section">
                            <h3><i class="fas fa-link"></i> Social Links</h3>
                            <div class="social-links-container" id="socialLinksContainer">
                                <div class="social-link-item">
                                    <select class="social-platform settings-input">
                                        <option value="github">GitHub</option>
                                        <option value="twitter">Twitter</option>
                                        <option value="linkedin">LinkedIn</option>
                                        <option value="website">Website</option>
                                        <option value="instagram">Instagram</option>
                                        <option value="youtube">YouTube</option>
                                    </select>
                                    <input type="url" class="social-url settings-input" placeholder="https://...">
                                    <button type="button" class="btn-icon remove-social" onclick="removeSocialLink(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn-secondary" onclick="addSocialLink()">
                                <i class="fas fa-plus"></i> Add Social Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeUserProfileModal()">Cancel</button>
                <button class="btn-primary" onclick="saveUserProfile()">
                    <i class="fas fa-save"></i> Save Profile
                </button>
            </div>
        </div>
    </div>

    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> Reset User Password</h2>
                <button class="close-btn" onclick="closeResetPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>You are about to reset the password for: <strong id="resetPasswordUsername"></strong></p>
                <div class="form-group">
                    <label for="newPasswordInput">New Password</label>
                    <div class="password-input-group">
                        <input type="password" id="newPasswordInput" class="settings-input">
                        <button type="button" class="btn-icon toggle-password" onclick="togglePasswordVisibility('newPasswordInput')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPasswordInput">Confirm Password</label>
                    <div class="password-input-group">
                        <input type="password" id="confirmPasswordInput" class="settings-input">
                        <button type="button" class="btn-icon toggle-password" onclick="togglePasswordVisibility('confirmPasswordInput')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="password-strength-meter">
                    <div class="strength-bar">
                        <div class="strength-indicator" id="passwordStrength"></div>
                    </div>
                    <span id="strengthText">Password strength</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeResetPasswordModal()">Cancel</button>
                <button class="btn-primary" id="confirmResetBtn" onclick="confirmPasswordReset()">
                    <i class="fas fa-save"></i> Reset Password
                </button>
            </div>
        </div>
    </div>

    <!-- Toast container -->
<div id="toast-container"></div>

<script>
function showToast(type, message) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icon = type === 'success' ? 'check-circle' : 
                 type === 'error' ? 'exclamation-circle' :
                 type === 'warning' ? 'exclamation-triangle' : 'info-circle';

    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
        </div>
    `;

    toastContainer.appendChild(toast);

    // Force reflow
    toast.offsetHeight;

    // Show the toast
    toast.classList.add('show');

    // Automatically remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.admin-section');

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();

            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            const sectionId = link.getAttribute('data-section');
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');
                    section.classList.add('section-entrance');
                    setTimeout(() => {
                        section.classList.remove('section-entrance');
                    }, 500);
                }
            });

            window.location.hash = sectionId;
        });
    });

    const hash = window.location.hash.substring(1);
    if (hash) {
        const activeLink = document.querySelector(`.nav-link[data-section="${hash}"]`);
        if (activeLink) {
            activeLink.click();
        }
    }

    const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
    const adminContainer = document.querySelector('.admin-container');

    sidebarCollapseBtn.addEventListener('click', () => {
        adminContainer.classList.toggle('sidebar-collapsed');
    });
    
    // Initialize all modal close buttons
    document.querySelectorAll('.close-btn').forEach(button => {
        button.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.visibility = 'hidden';
                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }, 300);
            }
        });
    });

    // Initialize action dropdowns
    initializeActionDropdowns();
    
    loadAdminList();
});

function filterUsers() {
    const searchTerm = document.getElementById('userSearch').value.trim();

    if (searchTerm.length < 2) {
        return; // Require at least 2 characters
    }

    // Show loading indicator
    document.getElementById('userTableBody').innerHTML = `
        <tr>
            <td colspan="8" class="text-center">
                <div class="loading-spinner"></div>
                <p>Searching users...</p>
            </td>
        </tr>
    `;

    // Make API call to search users
    fetch(`/api/admin/search/users?term=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';

            if (data.users.length === 0) {
                userTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <p>No users found matching "${searchTerm}"</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.users.forEach(user => {
                const row = document.createElement('tr');
                const currentUserId = {{ current_user.id }};
                
                row.innerHTML = `
                    <td>
                        ${user.id !== currentUserId ? 
                        `<input type="checkbox" class="user-select" data-userid="${user.id}" data-username="${user.username}" onchange="updateBulkActions()">` : 
                        ''}
                    </td>
                    <td>${user.id}</td>
                    <td>
                        <div class="user-table-info">
                            <div class="user-avatar-small">
                                ${user.avatar ? `<img src="${user.avatar}" alt="${user.username}">` : `<i class="fas fa-user"></i>`}
                            </div>
                            ${user.username}
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>${user.created_at}</td>
                    <td>${user.last_login || 'Never'}</td>
                    <td>
                        <span class="status-badge ${user.is_suspended ? 'suspended' : 'active'}">
                            ${user.is_suspended ? 'Suspended' : 'Active'}
                        </span>
                        ${user.is_club_leader ? 
                        `<span class="status-badge club-leader">
                            Club Leader
                        </span>` : ''}
                        ${user.is_admin ? 
                        `<span class="status-badge admin">
                            Admin
                        </span>` : ''}
                        ${user.is_profile_public ? 
                        `<span class="status-badge public-profile">
                            Public Profile
                        </span>` : ''}
                    </td>
                    <td class="actions-cell">
                        <div class="action-dropdown">
                            <button class="action-dropdown-btn">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-dropdown-content">
                                <button onclick="viewUserDetails(${user.id})" class="dropdown-item">
                                    <i class="fas fa-eye"></i>
                                    <span>View Details</span>
                                </button>
                                <button onclick="editUserProfile(${user.id})" class="dropdown-item">
                                    <i class="fas fa-user-edit"></i>
                                    <span>Edit Profile</span>
                                </button>
                                ${user.is_profile_public ? 
                                `<a href="/p/${user.username}" target="_blank" class="dropdown-item">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>View Public Profile</span>
                                </a>` : ''}
                                ${user.id !== currentUserId ? `
                                <button onclick="impersonateUser(${user.id}, '${user.username}')" class="dropdown-item">
                                    <i class="fas fa-user-secret"></i>
                                    <span>Impersonate User</span>
                                </button>
                                <button onclick="toggleSuspension(${user.id}, '${user.username}', ${!user.is_suspended})" class="dropdown-item">
                                    <i class="fas fa-${user.is_suspended ? 'user-check' : 'user-lock'}"></i>
                                    <span>${user.is_suspended ? 'Unsuspend' : 'Suspend'}</span>
                                </button>
                                <button onclick="toggleClubLeader(${user.id}, '${user.username}', ${user.is_club_leader})" class="dropdown-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span>${user.is_club_leader ? 'Remove Club Leader Role' : 'Grant Club Leader Role'}</span>
                                </button>
                                <button onclick="toggleAdminStatus(${user.id}, '${user.username}', ${!user.is_admin})" class="dropdown-item">
                                    <i class="fas fa-${user.is_admin ? 'user-minus' : 'user-shield'}"></i>
                                    <span>${user.is_admin ? 'Remove Admin' : 'Make Admin'}</span>
                                </button>
                                <button onclick="toggleStaffStatus(${user.id}, '${user.username}', ${!user.is_staff})" class="dropdown-item">
                                    <i class="fas fa-${user.is_staff ? 'user-minus' : 'briefcase'}"></i>
                                    <span>${user.is_staff ? 'Remove Staff' : 'Make Staff'}</span>
                                </button>
                                <button onclick="resetUserPassword(${user.id}, '${user.username}')" class="dropdown-item">
                                    <i class="fas fa-key"></i>
                                    <span>Reset Password</span>
                                </button>
                                <button onclick="deleteAllSites(${user.id}, '${user.username}')" class="dropdown-item">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Delete All Sites</span>
                                </button>
                                <button onclick="deleteUser(${user.id}, '${user.username}')" class="dropdown-item text-danger">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Delete User</span>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </td>
                `;

                userTableBody.appendChild(row);
                row.classList.add('fade-in');
                setTimeout(() => {
                    row.classList.remove('fade-in');
                }, 300);
            });
            
            // Initialize action dropdowns for the new search results properly
            initializeActionDropdowns();
        })
        .catch(error => {
            console.error('Error searching users:', error);
            showToast('error', 'Failed to search users');
        });
}

function filterSites() {
    const searchTerm = document.getElementById('siteSearch').value.trim();

    if (searchTerm.length < 2) {
        return; // Require at least 2 characters
    }

    document.getElementById('siteTableBody').innerHTML = `
        <tr>
            <td colspan="7" class="text-center">
                <div class="loading-spinner"></div>
                <p>Searching sites...</p>
            </td>
        </tr>
    `;

    // Make API call to search sites
    fetch(`/api/admin/search/sites?term=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            const siteTableBody = document.getElementById('siteTableBody');
            siteTableBody.innerHTML = '';

            if (data.sites.length === 0) {
                siteTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <p>No sites found matching "${searchTerm}"</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.sites.forEach(site => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${site.id}</td>
                    <td>
                        <div class="site-name">
                            <span class="site-icon">
                                <i class="fas fa-${site.site_type === 'web' ? 'globe' : 'code'}"></i>
                            </span>
                            ${site.name}
                        </div>
                    </td>
                    <td>${site.username}</td>
                    <td>
                        <span class="type-badge ${site.site_type}">
                            ${site.site_type.charAt(0).toUpperCase() + site.site_type.slice(1)}
                        </span>
                    </td>
                    <td>${site.created_at}</td>
                    <td>${site.updated_at}</td>
                    <td class="actions-cell">
                        <div class="action-dropdown">
                            <button class="action-dropdown-btn" onclick="toggleActionDropdown(this)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-dropdown-content">
                                <a href="/s/${site.slug}" target="_blank" class="dropdown-item">
                                    <i class="fas fa-eye"></i>
                                    <span>View Site</span>
                                </a>
                                <a href="/edit/${site.id}" class="dropdown-item">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span>Edit Site</span>
                                </a>
                                <button onclick="deleteSite(${site.id}, '${site.name}')" class="dropdown-item text-danger">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Delete Site</span>
                                </button>
                            </div>
                        </div>
                    </td>
                `;

                siteTableBody.appendChild(row);
                row.classList.add('fade-in');
                setTimeout(() => {
                    row.classList.remove('fade-in');
                }, 300);
            });
            
            // Initialize action dropdowns for the new search results
            initializeActionDropdowns();
        })
        .catch(error => {
            console.error('Error searching sites:', error);
            showToast('error', 'Failed to search sites');
        });
}

function filterClubs() {
    const searchTerm = document.getElementById('clubSearch').value.trim();

    if (searchTerm.length < 2) {
        return; // Require at least 2 characters
    }

    document.getElementById('clubTableBody').innerHTML = `
        <tr>
            <td colspan="7" class="text-center">
                <div class="loading-spinner"></div>
                <p>Searching clubs...</p>
            </td>
        </tr>
    `;

    // Make API call to search clubs
    fetch(`/api/admin/search/clubs?term=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast('error', data.error);
                return;
            }

            const clubTableBody = document.getElementById('clubTableBody');
            clubTableBody.innerHTML = '';

            if (data.clubs.length === 0) {
                clubTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <p>No clubs found matching "${searchTerm}"</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.clubs.forEach(club => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td>${club.id}</td>
                    <td>${club.name}</td>
                    <td>${club.leader_username}</td>
                    <td>${club.member_count}</td>
                    <td>${club.created_at}</td>
                    <td>${club.join_code}</td>
                    <td class="actions-cell">
                        <div class="action-dropdown">
                            <button class="action-dropdown-btn" onclick="toggleActionDropdown(this)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="action-dropdown-content">
                                <button onclick="viewClubDetails(${club.id})" class="dropdown-item">
                                    <i class="fas fa-eye"></i>
                                    <span>View Details</span>
                                </button>
                                <button onclick="resetJoinCode(${club.id})" class="dropdown-item">
                                    <i class="fas fa-key"></i>
                                    <span>Reset Join Code</span>
                                </button>
                                <button onclick="deleteClub(${club.id}, '${club.name}')" class="dropdown-item text-danger">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Delete Club</span>
                                </button>
                            </div>
                        </div>
                    </td>
                `;

                clubTableBody.appendChild(row);
                row.classList.add('fade-in');
                setTimeout(() => {
                    row.classList.remove('fade-in');
                }, 300);
            });
            
            // Initialize action dropdowns for the new search results
            initializeActionDropdowns();
        })
        .catch(error => {
            console.error('Error searching clubs:', error);
            showToast('error', 'Failed to search clubs');
        });
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-select');

    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });

    updateBulkActions();
}

function updateBulkActions() {
    const selectedUsers = document.querySelectorAll('.user-select:checked');
    const bulkActions = document.querySelectorAll('.bulk-action');

    bulkActions.forEach(button => {
        button.disabled = selectedUsers.length === 0;
    });
}

// Fetch total counts for dashboard stats
function fetchTotalCounts() {
    // Fetch total users count
    fetch('/api/admin/stats/counts')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalUsers').textContent = data.totalUsers;
            document.getElementById('totalSites').textContent = data.totalSites;
        })
        .catch(error => {
            console.error('Error fetching total counts:', error);
            document.getElementById('totalUsers').textContent = 'Error';
            document.getElementById('totalSites').textContent = 'Error';
        });
}

// Call this when page loads
document.addEventListener('DOMContentLoaded', function() {
    fetchTotalCounts();
});

function emailAllUsers() {
    const rows = document.getElementById('userTableBody').getElementsByTagName('tr');
    const emails = [];

    for (let row of rows) {
        const emailCell = row.cells[3]; 
        if (emailCell) {
            emails.push(emailCell.textContent.trim());
        }
    }

    if (emails.length > 0) {
        showToast('info', `Preparing email to ${emails.length} users`);
        window.location.href = `mailto:${emails.join(',')}`;
    } else {
        showToast('error', 'No email addresses found');
    }
}

async function toggleSuspension(userId, username, suspend) {
    if (!confirm(`Are you sure you want to ${suspend ? 'suspend' : 'unsuspend'} user "${username}"?`)) return;

    try {
        showToast('info', `Processing ${suspend ? 'suspension' : 'unsuspension'}...`);

        const response = await fetch(`/api/admin/users/${userId}/suspend`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ suspend })
        });

        if (response.ok) {
            showToast('success', `User ${suspend ? 'suspended' : 'unsuspended'} successfully`);
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to update user suspension status');
        }
    } catch (error) {
        showToast('error', 'Failed to update user suspension status');
    }
}

async function toggleClubLeader(userId, username, isClubLeader) {
    // Toggle based on current status - if currently a leader, remove; if not a leader, make one
    const makeLeader = !isClubLeader;
    if (!confirm(`Are you sure you want to ${makeLeader ? 'make' : 'remove'} "${username}" ${makeLeader ? 'as a' : 'from being a'} club leader?`)) return;

    try {
        showToast('info', `${makeLeader ? 'Adding' : 'Removing'} club leader status...`);

        const response = await fetch(`/api/admin/users/${userId}/club-leader`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_club_leader: makeLeader })
        });

        if (response.ok) {
            showToast('success', `User ${makeLeader ? 'is now' : 'is no longer'} a club leader`);
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to update club leader status');
        }
    } catch (error) {
        showToast('error', 'Failed to update club leader status');
    }
}

async function deleteAllSites(userId, username) {
    if (!confirm(`Are you sure you want to delete ALL sites for user "${username}"? This action cannot be undone.`)) return;

    try {
        showToast('info', 'Deleting sites...');

        const response = await fetch(`/api/admin/users/${userId}/sites`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('success', `All sites for user "${username}" deleted successfully`);
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to delete user sites');
        }
    } catch (error) {
        showToast('error', 'Failed to delete user sites');
    }
}

async function deleteUser(userId, username) {
    if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) return;

    try {
        showToast('info', 'Deleting user...');

        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('success', `User "${username}" deleted successfully`);
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to delete user');
        }
    } catch (error) {
        showToast('error', 'Failed to delete user');
    }
}

async function deleteSite(siteId, siteName) {
    if (!confirm(`Are you sure you want to delete site "${siteName}"? This action cannot be undone.`)) return;

    try {
        showToast('info', 'Deleting site...');

        const response = await fetch(`/api/admin/sites/${siteId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('success', `Site "${siteName}" deleted successfully`);
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            const data = await response.json();
            showToast('error', data.message || 'Failed to delete site');
        }
    } catch (error) {
        showToast('error', 'Failed to delete site');
    }
}

async function handleBulkAction(action) {
    const selectedUsers = Array.from(document.querySelectorAll('.user-select:checked')).map(checkbox => ({
        id: checkbox.dataset.userid,
        username: checkbox.dataset.username
    }));

    if (!selectedUsers.length) return;

    const actionMessages = {
        suspend: 'suspend',
        unsuspend: 'unsuspend',
        deleteSites: 'delete all sites for',
        deleteUsers: 'delete'
    };

    const usernames = selectedUsers.map(user => user.username).join(', ');
    if (!confirm(`Are you sure you want to ${actionMessages[action]} the following users: ${usernames}?`)) return;

    showToast('info', `Processing bulk action: ${action}...`);

    try {
        for (const user of selectedUsers) {
            let endpoint;
            let method = 'POST';

            switch(action) {
                case 'suspend':
                    endpoint = `/api/admin/users/${user.id}/suspend`;
                    break;
                case 'unsuspend':
                    endpoint = `/api/admin/users/${user.id}/suspend`;
                    break;
                case 'deleteSites':
                    endpoint = `/api/admin/users/${user.id}/sites`;
                    method = 'DELETE';
                    break;
                case 'deleteUsers':
                    endpoint = `/api/admin/users/${user.id}`;
                    method = 'DELETE';
                    break;
            }

            const response = await fetch(endpoint, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: action === 'suspend' ? JSON.stringify({ suspend: true }) :
                      action === 'unsuspend' ? JSON.stringify({ suspend: false }) :
                      null
            });

            if (!response.ok) throw new Error(`Failed to ${action} user ${user.username}`);
        }

        showToast('success', `Successfully performed ${action} on selected users`);
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        showToast('error', error.message);
    }
}

async function loadAdminList() {
    try {
        const response = await fetch('/api/admin/admins');
        if (response.ok) {
            const data = await response.json();
            const adminList = document.getElementById('adminList');
            adminList.innerHTML = '';

            const adminCount = document.getElementById('adminCount');
            if (adminCount) {
                adminCount.textContent = data.admins.length;
            }

            data.admins.forEach(admin => {
                const li = document.createElement('li');
                li.className = 'admin-item';

                const adminName = document.createElement('span');
                adminName.textContent = admin;
                adminName.className = 'admin-name';

                const adminEmail = document.createElement('span');
                adminEmail.textContent = '';
                adminEmail.className = 'admin-email';

                const adminInfo = document.createElement('div');
                adminInfo.className = 'admin-info';
                adminInfo.appendChild(adminName);
                adminInfo.appendChild(adminEmail);

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                removeButton.className = 'btn-icon remove-admin';
                removeButton.onclick = () => removeAdmin(admin);

                if (admin === '{{ current_user.username }}') {
                    removeButton.disabled = true;
                    removeButton.title = 'Cannot remove yourself';
                }

                li.appendChild(adminInfo);
                li.appendChild(removeButton);

                li.classList.add('fade-in');
                setTimeout(() => {
                    li.classList.remove('fade-in');
                }, 300);

                adminList.appendChild(li);
            });
        } else {
            showToast('error', 'Failed to load admin list');
        }
    } catch (error) {
        showToast('error', 'Failed to load admin list');
    }
}

async function addAdmin() {
    const username = document.getElementById('newAdminUsername').value.trim();
    if (!username) {
        showToast('error', 'Please enter a username');
        return;
    }

    try {
        showToast('info', 'Adding administrator...');

        const response = await fetch('/api/admin/admins/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username })
        });

        const data = await response.json();
        if (response.ok) {
            showToast('success', data.message);
            document.getElementById('newAdminUsername').value = '';
            loadAdminList();
        } else {
            showToast('error', data.error || 'Failed to add admin');
        }
    } catch (error) {
        showToast('error', 'Failed to add admin');
    }
}

async function removeAdmin(username) {
    if (!confirm(`Are you sure you want to remove ${username} as an administrator?`)) {
        return;
    }

    try {
        showToast('info', 'Removing administrator...');

        const response = await fetch('/api/admin/admins/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username })
        });

        const data = await response.json();
        if (response.ok) {
            showToast('success', data.message);
            loadAdminList();
        } else {
            showToast('error', data.error || 'Failed to remove admin');
        }
    } catch (error) {
        showToast('error', 'Failed to remove admin');
    }
}

function viewUserDetails(userId) {
    const modal = document.getElementById('userDetailModal');
    const userDetailContent = document.getElementById('userDetailContent');
    const editUserForm = document.getElementById('editUserForm');

    if (!modal || !userDetailContent) {
        showToast('error', 'Could not find modal elements');
        return;
    }

    userDetailContent.innerHTML = `
        <div class="user-detail-loading">
            <div class="loading-spinner"></div>
            <p>Loading user details...</p>
        </div>
    `;

    // Explicitly set display style to make modal visible
    modal.style.display = 'flex';
    modal.style.opacity = '1';
    modal.style.visibility = 'visible';
    document.body.style.overflow = 'hidden';

    fetchUserDetails(userId, userDetailContent, editUserForm);
}

async function fetchUserDetails(userId, userDetailContent, editUserForm) {
    try {
        const response = await fetch(`/api/users/${userId}`);
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }
        
        const userData = await response.json();
        
        if (userData) {
            // Load and display user avatar
            const avatarPreview = document.getElementById('userAvatarPreview');
            if (avatarPreview) {
                if (userData.avatar_url) {
                    avatarPreview.src = userData.avatar_url;
                } else {
                    avatarPreview.innerHTML = '<i class="fas fa-user-circle"></i>';
                }
            }
            
            userDetailContent.innerHTML = `
                <h3>${userData.username}</h3>
                <div class="user-meta">
                    <p><i class="fas fa-envelope"></i> ${userData.email}</p>
                    <p><i class="fas fa-calendar-alt"></i> Joined: ${new Date(userData.created_at).toLocaleDateString()}</p>
                    <p><i class="fas fa-clock"></i> Last active: ${userData.last_login ? new Date(userData.last_login).toLocaleDateString() : 'Never'}</p>
                    <p><i class="fas fa-globe"></i> Status: ${userData.is_suspended ? '<span class="badge badge-danger">Suspended</span>' : '<span class="badge badge-success">Active</span>'}</p>
                </div>
                
                <div class="user-stats">
                    <div class="stat-item">
                        <span class="stat-value">${userData.site_count || 0}</span>
                        <span class="stat-label">Sites</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${userData.deploy_count || 0}</span>
                        <span class="stat-label">Deploys</span>
                    </div>
                </div>
                
                <div class="user-actions">
                    <button onclick="editUserProfile(${userData.id})" class="btn-primary">
                        <i class="fas fa-user-edit"></i> Edit Profile
                    </button>
                    ${userData.is_profile_public ? 
                    `<a href="/p/${userData.username}" target="_blank" class="btn-secondary">
                        <i class="fas fa-external-link-alt"></i> View Public Profile
                    </a>` : ''}
                </div>
            `;
            
            // Prepopulate edit form for convenience
            if (editUserForm) {
                const editUserIdField = editUserForm.querySelector('#editUserId');
                const editUsernameField = editUserForm.querySelector('#editUsername');
                const editEmailField = editUserForm.querySelector('#editEmail');
                
                if (editUserIdField) editUserIdField.value = userData.id;
                if (editUsernameField) editUsernameField.value = userData.username;
                if (editEmailField) editEmailField.value = userData.email;
            }
        } else {
            userDetailContent.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>User not found</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error fetching user details:', error);
        userDetailContent.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Error loading user details: ${error.message}</p>
            </div>
        `;
    }
}

function closeUserDetailModal() {
    const modal = document.getElementById('userDetailModal');
    modal.style.opacity = '0';
    modal.style.visibility = 'hidden';
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }, 300);
}

function closeUserProfileModal() {
    const modal = document.getElementById('userProfileModal');
    modal.style.opacity = '0';
    modal.style.visibility = 'hidden';
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }, 300);
}

function saveUserChanges() {
    const userId = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const password = document.getElementById('resetPassword').value;
    const isPublicProfile = document.getElementById('editIsPublicProfile').checked;

    if (!userId) {
        showToast('error', 'User ID is missing');
        return;
    }

    const userData = {
        username: username,
        email: email,
        is_profile_public: isPublicProfile
    };

    if (password) {
        userData.password = password;
    }

    fetch(`/api/admin/users/${userId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'User information updated successfully');
            closeUserDetailModal();
            
            // Refresh the page after a short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('error', data.message || 'Failed to update user information');
        }
    })
    .catch(error => {
        console.error('Error updating user:', error);
        showToast('error', 'An error occurred while updating user information');
    });
}

// Function to toggle action dropdown visibility
function toggleActionDropdown(button) {
    // Safety check for the button
    if (!button) {
        console.error("Toggle action dropdown called with null button");
        return;
    }

    // Close all other open dropdowns first
    const allDropdowns = document.querySelectorAll('.action-dropdown-content.show');
    allDropdowns.forEach(dropdown => {
        const parentButton = dropdown.previousElementSibling || document.getElementById(dropdown.dataset.parentButton);
        if (parentButton && parentButton !== button) {
            dropdown.classList.remove('show');
            dropdown.style.position = '';
            dropdown.style.top = '';
            dropdown.style.left = '';
            dropdown.style.bottom = '';
            if (dropdown.parentElement === document.body && parentButton) {
                parentButton.after(dropdown);
            }
        }
    });
    
    // Toggle the clicked dropdown
    const dropdownContent = button.nextElementSibling;
    
    // Safety check for dropdown content
    if (!dropdownContent) {
        console.error("Dropdown content not found for button", button);
        return;
    }
    
    // Toggle show class
    if (dropdownContent.classList.contains('show')) {
        dropdownContent.classList.remove('show');
        dropdownContent.style.position = '';
        dropdownContent.style.top = '';
        dropdownContent.style.left = '';
        dropdownContent.style.bottom = '';
        
        // If the dropdown is currently a child of the body, move it back
        if (dropdownContent.parentElement === document.body) {
            button.after(dropdownContent);
        }
    } else {
        dropdownContent.classList.add('show');
        
        // Set up positioning
        dropdownContent.style.position = 'fixed';
        dropdownContent.style.zIndex = '9999';
        
        // Store reference to the button
        dropdownContent.dataset.parentButton = button.id || Math.random().toString(36).substring(2);
        if (!button.id) button.id = dropdownContent.dataset.parentButton;
        
        // Move to body to escape overflow constraints
        document.body.appendChild(dropdownContent);
        
        // Position the dropdown
        const buttonRect = button.getBoundingClientRect();
        
        // Calculate space
        const spaceBelow = window.innerHeight - buttonRect.bottom;
        const spaceAbove = buttonRect.top;
        
        // Position vertically
        if (spaceBelow >= 150 || spaceBelow > spaceAbove) {
            dropdownContent.style.top = `${buttonRect.bottom + 5}px`;
            dropdownContent.style.bottom = 'auto';
        } else {
            dropdownContent.style.bottom = `${window.innerHeight - buttonRect.top + 5}px`;
            dropdownContent.style.top = 'auto';
        }
        
        // Position horizontally
        dropdownContent.style.left = `${buttonRect.left}px`;
        
        // Ensure it doesn't go off-screen
        requestAnimationFrame(() => {
            const dropdownRect = dropdownContent.getBoundingClientRect();
            if (dropdownRect.right > window.innerWidth) {
                dropdownContent.style.left = `${buttonRect.right - dropdownRect.width}px`;
            }
            if (dropdownRect.left < 0) {
                dropdownContent.style.left = '10px';
            }
        });
        
        // Add click outside handler
        setTimeout(() => {
            function closeDropdown(e) {
                if (!button.contains(e.target) && !dropdownContent.contains(e.target)) {
                    dropdownContent.classList.remove('show');
                    dropdownContent.style.position = '';
                    dropdownContent.style.top = '';
                    dropdownContent.style.left = '';
                    dropdownContent.style.bottom = '';
                    dropdownContent.style.zIndex = '';
                    
                    if (dropdownContent.parentElement === document.body) {
                        button.after(dropdownContent);
                    }
                    
                    document.removeEventListener('click', closeDropdown);
                }
            }
            
            document.addEventListener('click', closeDropdown);
        }, 10);
    }
}

function initializeActionDropdowns() {
    // Add event listeners to all dropdown buttons
    document.querySelectorAll('.action-dropdown-btn').forEach(button => {
        // Check if button already has the onclick attribute
        if (!button.onclick) {
            button.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleActionDropdown(this);
            };
        }
        
        // Ensure the dropdown can appear outside the table container
        const dropdownContent = button.nextElementSibling;
        if (dropdownContent && dropdownContent.classList.contains('action-dropdown-content')) {
            dropdownContent.style.position = 'absolute';
            dropdownContent.style.zIndex = '1000';
            
            // Prevent dropdown item clicks from closing immediately
            dropdownContent.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }
    });
    
    // Ensure dropdowns are properly positioned
    window.addEventListener('resize', function() {
        const visibleDropdown = document.querySelector('.action-dropdown-content.show');
        if (visibleDropdown) {
            const parentButton = document.getElementById(visibleDropdown.dataset.parentButton);
            if (parentButton) {
                toggleActionDropdown(parentButton); // Close
                toggleActionDropdown(parentButton); // Reopen with proper positioning
            } else {
                visibleDropdown.classList.remove('show'); // Just close if we can't find the button
            }
        }
    });
}

// Call this function when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeActionDropdowns();
});

// Create a custom modal for context menu actions
function openActionModal(userId, username) {
    // Close any open dropdowns
    const allDropdowns = document.querySelectorAll('.action-dropdown-content');
    allDropdowns.forEach(dropdown => {
        dropdown.classList.remove('show');
    });
    
    // Get user data
    fetch(`/api/users/${userId}`)
        .then(response => response.json())
        .then(userData => {
            // Create modal HTML
            const modalHTML = `
                <div id="actionModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-user-cog"></i> ${username} - Actions</h2>
                            <button class="close-btn" onclick="document.getElementById('actionModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="action-grid">
                                <button onclick="viewUserDetails(${userId}); document.getElementById('actionModal').remove();" class="action-btn">
                                    <i class="fas fa-eye"></i>
                                    <span>View Details</span>
                                </button>
                                <button onclick="editUserProfile(${userId}); document.getElementById('actionModal').remove();" class="action-btn">
                                    <i class="fas fa-user-edit"></i>
                                    <span>Edit Profile</span>
                                </button>
                                ${userData.is_profile_public ? 
                                `<a href="/p/${username}" target="_blank" class="action-btn">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>View Public Profile</span>
                                </a>` : 
                                `<button class="action-btn disabled">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>Profile Not Public</span>
                                </button>`}
                                ${userId !== parseInt(currentUserId) ? 
                                `<button onclick="impersonateUser(${userId}, '${username}'); document.getElementById('actionModal').remove();" class="action-btn">
                                    <i class="fas fa-user-secret"></i>
                                    <span>Impersonate User</span>
                                </button>
                                <button onclick="toggleSuspension(${userId}, '${username}', ${!userData.is_suspended}); document.getElementById('actionModal').remove();" class="action-btn ${userData.is_suspended ? 'success-action' : 'danger-action'}">
                                    <i class="fas fa-${userData.is_suspended ? 'user-check' : 'user-lock'}"></i>
                                    <span>${userData.is_suspended ? 'Unsuspend' : 'Suspend'}</span>
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer.firstElementChild);
            
            // Show modal
            document.getElementById('actionModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error fetching user data:', error);
            showToast('error', 'Failed to load user data');
        });
}

function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
}

function editClubBalance(clubId, currentBalance) {
    const newBalance = prompt(`Enter new balance for club (current: $${currentBalance.toFixed(2)}):`);
    
    if (newBalance === null) return; // User cancelled
    
    const balance = parseFloat(newBalance);
    if (isNaN(balance) || balance < 0) {
        showToast('error', 'Please enter a valid positive number');
        return;
    }
    
    fetch(`/api/admin/clubs/${clubId}/balance`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ balance: balance })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showToast('error', data.error);
        } else {
            showToast('success', data.message);
            // Update the displayed balance
            const balanceElement = document.getElementById(`balance-${clubId}`);
            if (balanceElement) {
                balanceElement.textContent = `$${balance.toFixed(2)}`;
            }
        }
    })
    .catch(error => {
        console.error('Error updating club balance:', error);
        showToast('error', 'Failed to update club balance');
    });
}

function refreshData() {
    showToast('info', 'Refreshing data...');
    fetchUsersStats();
    setTimeout(() => {
        location.reload();
    }, 1000);
}

async function fetchUsersStats() {
    try {
        const response = await fetch('/api/admin/users-stats');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('newUsersCount').textContent = data.newUsers;
            document.getElementById('activeUsers').textContent = data.activeUsers;
            document.getElementById('suspendedUsers').textContent = data.suspendedUsers;
        }
    } catch (error) {
        console.error('Error fetching user stats:', error);
    }
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function editUserProfile(userId) {
    // Find necessary elements
    const profileForm = document.getElementById('profileEditForm');
    const socialLinksContainer = document.getElementById('socialLinksContainer');
    const userProfileModal = document.getElementById('userProfileModal');
    
    if (!profileForm || !socialLinksContainer || !userProfileModal) {
        showToast('error', 'Could not find necessary elements for profile editing');
        return;
    }
    
    // Reset form
    profileForm.reset();
    socialLinksContainer.innerHTML = '';
    
    const profileUserIdField = document.getElementById('profileUserId');
    if (profileUserIdField) {
        profileUserIdField.value = userId;
    }
    
    // Show modal with explicit visibility settings
    userProfileModal.style.display = 'flex';
    userProfileModal.style.opacity = '1';
    userProfileModal.style.visibility = 'visible';
    document.body.style.overflow = 'hidden';
    
    // Fetch user details
    fetch(`/api/users/${userId}/profile`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch user profile');
            }
            return response.json();
        })
        .then(data => {
            console.log("Loaded profile data:", data);
            // Fill form with user data
            const fields = {
                'profileUsername': data.username,
                'profileEmail': data.email,
                'profileBio': data.bio || '',
                'profileAvatar': data.avatar_url || '',
                'profileBanner': data.banner_url || ''
            };
            
            // Safely update each field
            Object.keys(fields).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = fields[fieldId];
                }
            });
            
            // Handle checkbox separately
            const isPublicCheckbox = document.getElementById('profileIsPublic');
            if (isPublicCheckbox) {
                isPublicCheckbox.checked = data.is_profile_public;
            }
            
            // Update preview - safely
            updateProfilePreview();
            
            // Add social links
            if (data.social_links && Array.isArray(data.social_links) && data.social_links.length > 0) {
                socialLinksContainer.innerHTML = '';
                data.social_links.forEach(link => {
                    if (typeof addSocialLinkWithData === 'function') {
                        addSocialLinkWithData(link.platform, link.url);
                    } else if (typeof addSocialLink === 'function') {
                        addSocialLink();
                        // Try to populate the last added link
                        const lastLink = socialLinksContainer.lastElementChild;
                        if (lastLink) {
                            const platformSelect = lastLink.querySelector('.social-platform');
                            const urlInput = lastLink.querySelector('.social-url');
                            if (platformSelect) platformSelect.value = link.platform;
                            if (urlInput) urlInput.value = link.url;
                        }
                    }
                });
            }
            
            // If no social links were added, add an empty one
            if (socialLinksContainer.children.length === 0 && typeof addSocialLink === 'function') {
                addSocialLink();
            }
        })
        .catch(error => {
            console.error('Error fetching user profile:', error);
            showToast('error', 'Failed to load user profile: ' + error.message);
        });
}

function updateProfilePreview() {
    const username = document.getElementById('profileUsername').value;
    const bio = document.getElementById('profileBio').value;
    const avatar = document.getElementById('profileAvatar').value;
    const banner = document.getElementById('profileBanner').value;
    
    document.getElementById('previewUsername').textContent = username;
    document.getElementById('previewBio').textContent = bio || 'No bio provided';
    
    const previewAvatar = document.getElementById('previewAvatar');
    if (avatar) {
        previewAvatar.innerHTML = `<img src="${avatar}" alt="${username}" onerror="this.onerror=null; this.parentNode.innerHTML = '<i class=\\'fas fa-user\\'></i>'">`;
    } else {
        previewAvatar.innerHTML = '<i class="fas fa-user"></i>';
    }
    
    const previewBanner = document.getElementById('previewBanner');
    if (banner) {
        previewBanner.style.backgroundImage = `url(${banner})`;
    } else {
        previewBanner.style.backgroundImage = '';
    }
}

function addSocialLink() {
    const container = document.getElementById('socialLinksContainer');
    const socialLinkItem = document.createElement('div');
    socialLinkItem.className = 'social-link-item';
    socialLinkItem.innerHTML = `
        <select class="social-platform settings-input">
            <option value="github">GitHub</option>
            <option value="twitter">Twitter</option>
            <option value="linkedin">LinkedIn</option>
            <option value="website">Website</option>
            <option value="instagram">Instagram</option>
            <option value="youtube">YouTube</option>
        </select>
        <input type="url" class="social-url settings-input" placeholder="https://...">
        <button type="button" class="btn-icon remove-social" onclick="removeSocialLink(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(socialLinkItem);
}

function addSocialLinkWithValues(platform, url) {
    const container = document.getElementById('socialLinksContainer');
    const socialLinkItem = document.createElement('div');
    socialLinkItem.className = 'social-link-item';
    socialLinkItem.innerHTML = `
        <select class="social-platform settings-input">
            <option value="github">GitHub</option>
            <option value="twitter">Twitter</option>
            <option value="linkedin">LinkedIn</option>
            <option value="website">Website</option>
            <option value="instagram">Instagram</option>
            <option value="youtube">YouTube</option>
        </select>
        <input type="url" class="social-url settings-input" placeholder="https://..." value="${url}">
        <button type="button" class="btn-icon remove-social" onclick="removeSocialLink(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(socialLinkItem);
    
    // Set the selected platform
    const select = socialLinkItem.querySelector('.social-platform');
    select.value = platform;
}

// Add the missing function
function addSocialLinkWithData(platform, url) {
    addSocialLinkWithValues(platform, url);
}

function removeSocialLink(button) {
    const container = document.getElementById('socialLinksContainer');
    const item = button.closest('.social-link-item');
    container.removeChild(item);
}

function saveUserProfile() {
    const userId = document.getElementById('profileUserId').value;
    const bio = document.getElementById('profileBio').value;
    const avatar = document.getElementById('profileAvatar').value;
    const banner = document.getElementById('profileBanner').value;
    const isPublic = document.getElementById('profileIsPublic').checked;
    
    // Gather social links
    const socialLinks = {};
    const socialItems = document.querySelectorAll('.social-link-item');
    socialItems.forEach(item => {
        const platform = item.querySelector('.social-platform').value;
        const url = item.querySelector('.social-url').value;
        if (url.trim()) {
            socialLinks[platform] = url;
        }
    });
    
    // Prepare data
    const formData = {
        bio: bio,
        avatar: avatar,
        profile_banner: banner,
        is_profile_public: isPublic,
        social_links: socialLinks
    };
    
    // Send to server
    fetch(`/api/admin/users/${userId}/profile`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Profile updated successfully');
            closeUserProfileModal();
            
            // Update user list if possible
            const userRows = document.querySelectorAll(`#userTableBody tr`);
            for (const row of userRows) {
                const rowUserId = row.querySelector('.user-select')?.dataset?.userid;
                if (rowUserId === userId) {
                    // Update avatar in table
                    const avatarContainer = row.querySelector('.user-avatar-small');
                    if (avatarContainer) {
                        if (avatar) {
                            avatarContainer.innerHTML = `<img src="${avatar}" alt="User avatar" onerror="this.onerror=null; this.parentNode.innerHTML = '<i class=\\'fas fa-user\\'></i>'">`;
                        } else {
                            avatarContainer.innerHTML = '<i class="fas fa-user"></i>';
                        }
                    }
                    
                    // Update public profile badge
                    const badges = row.querySelector('td:nth-child(7)');
                    if (badges) {
                        const publicBadge = Array.from(badges.querySelectorAll('.status-badge')).find(b => b.classList.contains('public-profile'));
                        if (isPublic && !publicBadge) {
                            badges.innerHTML += `<span class="status-badge public-profile">Public Profile</span>`;
                        } else if (!isPublic && publicBadge) {
                            publicBadge.remove();
                        }
                    }
                    break;
                }
            }
        } else {
            showToast('error', data.message || 'Failed to update profile');
        }
    })
    .catch(error => {
        console.error('Error updating profile:', error);
        showToast('error', 'An error occurred while updating the profile');
    });
}

// Listen for changes to preview fields
document.addEventListener('DOMContentLoaded', function() {
    const previewFields = ['profileUsername', 'profileBio', 'profileAvatar', 'profileBanner'];
    previewFields.forEach(field => {
        const element = document.getElementById(field);
        if (element) {
            element.addEventListener('input', updateProfilePreview);
        }
    });
    
    // Setup password strength meter
    if (document.getElementById('newPasswordInput')) {
        document.getElementById('newPasswordInput').addEventListener('input', checkPasswordStrength);
    }
    
    // Fetch initial user stats
    fetchUsersStats();
});

function checkPasswordStrength() {
    const password = document.getElementById('newPasswordInput').value;
    const indicator = document.getElementById('passwordStrength');
    const text = document.getElementById('strengthText');
    
    if (!password) {
        indicator.style.width = '0';
        indicator.style.backgroundColor = '#e0e0e0';
        text.textContent = 'Password strength';
        text.style.color = 'var(--text-secondary)';
        return;
    }
    
    // Check strength
    let strength = 0;
    if (password.length >= 8) strength += 25;
    if (password.match(/[a-z]+/)) strength += 25;
    if (password.match(/[A-Z]+/)) strength += 25;
    if (password.match(/[0-9]+/)) strength += 25;
    if (password.match(/[^a-zA-Z0-9]+/)) strength += 25;
    
    // Cap at 100
    strength = Math.min(strength, 100);
    
    // Update UI
    indicator.style.width = strength + '%';
    
    if (strength < 30) {
        indicator.style.backgroundColor = '#f44336';
        text.textContent = 'Weak';
        text.style.color = '#f44336';
    } else if (strength < 60) {
        indicator.style.backgroundColor = '#ff9800';
        text.textContent = 'Moderate';
        text.style.color = '#ff9800';
    } else if (strength < 80) {
        indicator.style.backgroundColor = '#4caf50';
        text.textContent = 'Strong';
        text.style.color = '#4caf50';
    } else {
        indicator.style.backgroundColor = '#2e7d32';
        text.textContent = 'Very Strong';
        text.style.color = '#2e7d32';
    }
    
    // Check if passwords match
    const confirmPassword = document.getElementById('confirmPasswordInput').value;
    if (confirmPassword && password !== confirmPassword) {
        text.textContent += ' - Passwords do not match';
        text.style.color = '#f44336';
        document.getElementById('confirmResetBtn').disabled = true;
    } else if (confirmPassword) {
        text.textContent += ' - Passwords match';
        document.getElementById('confirmResetBtn').disabled = false;
    }
}

function resetUserPassword(userId, username) {
    document.getElementById('resetPasswordUsername').textContent = username;
    document.getElementById('newPasswordInput').value = '';
    document.getElementById('confirmPasswordInput').value = '';
    document.getElementById('passwordStrength').style.width = '0';
    document.getElementById('strengthText').textContent = 'Password strength';
    document.getElementById('confirmResetBtn').setAttribute('data-userid', userId);
    
    document.getElementById('resetPasswordModal').style.display = 'flex';
}

function confirmPasswordReset() {
    const userId = document.getElementById('confirmResetBtn').getAttribute('data-userid');
    const newPassword = document.getElementById('newPasswordInput').value;
    const confirmPassword = document.getElementById('confirmPasswordInput').value;
    
    if (!newPassword) {
        showToast('error', 'Password cannot be empty');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showToast('error', 'Passwords do not match');
        return;
    }
    
    fetch(`/api/admin/users/${userId}/reset-password`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Password reset successfully');
            closeResetPasswordModal();
        } else {
            showToast('error', data.message || 'Failed to reset password');
        }
    })
    .catch(error => {
        console.error('Error resetting password:', error);
        showToast('error', 'An error occurred while resetting the password');
    });
}

function toggleAdminStatus(userId, username, makeAdmin) {
    if (!confirm(`Are you sure you want to ${makeAdmin ? 'make' : 'remove'} ${username} ${makeAdmin ? 'an admin' : 'from admin role'}?`)) {
        return;
    }
    
    fetch(`/api/admin/users/${userId}/admin-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_admin: makeAdmin })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', `User ${makeAdmin ? 'is now an admin' : 'is no longer an admin'}`);
            
            // Update UI
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('error', data.message || 'Failed to update admin status');
        }
    })
    .catch(error => {
        console.error('Error updating admin status:', error);
        showToast('error', 'An error occurred while updating admin status');
    });
}

function toggleStaffStatus(userId, username, makeStaff) {
    if (!confirm(`Are you sure you want to ${makeStaff ? 'make' : 'remove'} ${username} ${makeStaff ? 'a staff member' : 'from staff role'}?`)) {
        return;
    }
    
    fetch(`/api/admin/users/${userId}/staff-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_staff: makeStaff })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', `User ${makeStaff ? 'is now a staff member' : 'is no longer a staff member'}`);
            
            // Update UI
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('error', data.message || 'Failed to update staff status');
        }
    })
    .catch(error => {
        console.error('Error updating staff status:', error);
        showToast('error', 'An error occurred while updating staff status');
    });
}

function impersonateUser(userId, username) {
    if (!confirm(`Are you sure you want to impersonate ${username}? You will be logged in as this user.`)) {
        return;
    }
    
    fetch(`/api/admin/impersonate/${userId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', `Now impersonating ${username}. Redirecting...`);
            setTimeout(() => {
                window.location.href = data.redirect || '/welcome';
            }, 1500);
        } else {
            showToast('error', data.message || 'Failed to impersonate user');
        }
    })
    .catch(error => {
        console.error('Error impersonating user:', error);
        showToast('error', 'An error occurred while impersonating the user');
    });
}

function exportUserData() {
    const selectedUsers = Array.from(document.querySelectorAll('.user-select:checked'));
    if (selectedUsers.length === 0) {
        showToast('warning', 'Please select at least one user to export');
        return;
    }
    
    const userIds = selectedUsers.map(checkbox => checkbox.dataset.userid);
    
    fetch('/api/admin/export-users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ user_ids: userIds })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `user_export_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        showToast('success', 'Export successful');
    })
    .catch(error => {
        console.error('Export error:', error);
        showToast('error', 'Failed to export user data');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    loadSystemStatus();
    loadRecentActivities();
    updateAnalytics('day');
    loadLeaderAccessCode();
});

async function loadSystemStatus() {
    try {
        const response = await fetch('/api/admin/system-status');
        const data = await response.json();

        const serverStatusEl = document.getElementById('serverStatus');
        serverStatusEl.innerHTML = data.server.status === 'healthy' 
            ? `Healthy <i class="fas fa-check-circle"></i>` 
            : `Unhealthy <i class="fas fa-exclamation-circle"></i>`;
        serverStatusEl.className = `status-value ${data.server.status}`;

        const dbStatusEl = document.getElementById('databaseStatus');
        dbStatusEl.innerHTML = data.database.status === 'healthy' 
            ? `Connected <i class="fas fa-check-circle"></i>` 
            : `Disconnected <i class="fas fa-exclamation-circle"></i>`;
        dbStatusEl.className = `status-value ${data.database.status}`;

        const lastBackupEl = document.getElementById('lastBackup');
        lastBackupEl.textContent = data.backup.last_backup || 'Not available';
    } catch (error) {
        console.error('Error loading system status:', error);
        document.getElementById('serverStatus').innerHTML = `Unknown <i class="fas fa-question-circle"></i>`;
        document.getElementById('databaseStatus').innerHTML = `Unknown <i class="fas fa-question-circle"></i>`;
        document.getElementById('lastBackup').textContent = 'Not available';
    }
}

function loadVisitData() {
    loadRecentActivities(true);
}

function loadRecentActivities(replaceAll = true) {
    fetch('/api/admin/recent-activities')
        .then(response => response.json())
        .then(data => {
            const activitiesList = document.getElementById('recentActivitiesList');
            if (replaceAll) {
                activitiesList.innerHTML = '';
            }

            if (data.activities && data.activities.length > 0) {
                data.activities.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';

                    const activityIcon = document.createElement('div');
                    activityIcon.className = 'activity-icon';

                    let iconClass = 'fa-info-circle';
                    switch (activity.type) {
                        case 'user_registration':
                            iconClass = 'fa-user-plus';
                            break;
                        case 'site_creation':
                            iconClass = 'fa-globe';
                            break;
                        case 'admin_change':
                            iconClass = 'fa-user-shield';
                            break;
                        case 'site_deletion':
                            iconClass = 'fa-trash-alt';
                            break;
                        case 'user_login':
                            iconClass = 'fa-sign-in-alt';
                            break;
                    }

                    activityIcon.innerHTML = `<i class="fas ${iconClass}"></i>`;

                    const activityDetails = document.createElement('div');
                    activityDetails.className = 'activity-details';

                    let message = activity.message;
                    if (activity.username) {
                        message = message.replace('{username}', `<strong>${activity.username}</strong>`);
                    }

                    activityDetails.innerHTML = `
                        <p>${message}</p>
                        <span class="activity-time">${formatTimeAgo(activity.timestamp)}</span>
                    `;

                    li.appendChild(activityIcon);
                    li.appendChild(activityDetails);
                    activitiesList.appendChild(li);

                    setTimeout(() => {
                        li.classList.add('fade-in');
                    }, 100 * activitiesList.children.length);
                });
            } else {
                activitiesList.innerHTML = `
                    <li class="activity-item">
                        <div class="activity-details">
                            <p>No recent activities found</p>
                        </div>
                    </li>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading recent activities:', error);
            document.getElementById('recentActivitiesList').innerHTML = `
                <li class="activity-item">
                    <div class="activity-details">
                        <p>Failed to load recent activities</p>
                    </div>
                </li>
            `;
        });
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const activityTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now - activityTime) / 1000);

    if (diffInSeconds < 60) {
        return 'just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    } else {
        return activityTime.toLocaleDateString();
    }
}

async function updateAnalytics(period) {
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.time-btn[data-period="${period}"]`).classList.add('active');

    try {
        showLoadingState();
        const response = await fetch(`/api/admin/analytics?period=${period}`);
        const data = await response.json();

        renderUserRegistrationsChart(data.user_registrations);
        renderSiteTypesChart(data.site_types);
        renderTrafficSourcesChart(data.traffic_sources);
        renderPlatformUsageChart(data.platform_usage);
    } catch (error) {
        console.error('Error loading analytics data:', error);
        showErrorState();
    }
}

function showLoadingState() {
    document.getElementById('userRegistrationsChart').innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading chart data...</p>
    `;
    document.getElementById('siteTypesChart').innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading chart data...</p>
    `;
    document.getElementById('trafficSourcesChart').innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading chart data...</p>
    `;
    document.getElementById('platformUsageChart').innerHTML = `
        <div class="loading-spinner"></div>
        <p>Loading chart data...</p>
    `;
}

function showErrorState() {
    const errorMessage = `
        <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Failed to load analytics data</p>
        </div>
    `;

    document.getElementById('userRegistrationsChart').innerHTML = errorMessage;
    document.getElementById('siteTypesChart').innerHTML = errorMessage;
    document.getElementById('trafficSourcesChart').innerHTML = errorMessage;
    document.getElementById('platformUsageChart').innerHTML = errorMessage;
}

function renderUserRegistrationsChart(data) {
    const chartContainer = document.getElementById('userRegistrationsChart');
    chartContainer.innerHTML = '';

    const chartBars = document.createElement('div');
    chartBars.className = 'chart-bars';

    const maxValue = Math.max(...data.values, 1);

    data.values.forEach((value, index) => {
        const height = (value / maxValue) * 100;
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.height = `${height}%`;

        bar.setAttribute('title', `${data.labels[index]}: ${value} registrations`);

        chartBars.appendChild(bar);

        setTimeout(() => {
            bar.style.height = `${height}%`;
        }, 100 * index);
    });

    chartContainer.appendChild(chartBars);
}

function renderSiteTypesChart(data) {
    const chartContainer = document.getElementById('siteTypesChart');
    chartContainer.innerHTML = '';

    const webPercentage = data.web;
    const pythonPercentage = data.python;

    const pieChart = document.createElement('div');
    pieChart.className = 'pie-chart';

    const webSegment = document.createElement('div');
    webSegment.className = 'pie-segment';
    webSegment.style.transform = 'rotate(0deg)';
    webSegment.style.backgroundColor = 'var(--primary)';

    const pythonSegment = document.createElement('div');
    pythonSegment.className = 'pie-segment';
    pythonSegment.style.transform = `rotate(${webPercentage * 3.6}deg)`;
    pythonSegment.style.backgroundColor = 'var(--accent)';

    const pieCenter = document.createElement('div');
    pieCenter.className = 'pie-center';
    pieCenter.textContent = `${webPercentage}%`;

    pieChart.appendChild(webSegment);
    pieChart.appendChild(pythonSegment);
    pieChart.appendChild(pieCenter);

    const chartLegend = document.createElement('div');
    chartLegend.className = 'chart-legend';

    chartLegend.innerHTML = `
        <div class="legend-item">
            <span class="legend-color" style="background-color: var(--primary);"></span>
            <span>Web Sites (${webPercentage}%)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color" style="background-color: var(--accent);"></span>
            <span>Python Sites (${pythonPercentage}%)</span>
        </div>
    `;

    chartContainer.appendChild(pieChart);
    chartContainer.appendChild(chartLegend);

    setTimeout(() => {
        pieCenter.textContent = `${webPercentage}%`;
        pythonSegment.style.transform = `rotate(${webPercentage * 3.6}deg)`;
    }, 300);
}

function renderTrafficSourcesChart(data) {
    const chartContainer = document.getElementById('trafficSourcesChart');
    chartContainer.innerHTML = '';

    const horizontalBars = document.createElement('div');
    horizontalBars.className = 'horizontal-bars';

    Object.entries(data).forEach(([source, percentage]) => {
        const barItem = document.createElement('div');
        barItem.className = 'horizontal-bar-item';

        barItem.innerHTML = `
            <span class="bar-label">${source}</span>
            <div class="bar-container">
                <div class="horizontal-bar" style="width: 0%"></div>
            </div>
            <span class="bar-value">${percentage}%</span>
        `;

        horizontalBars.appendChild(barItem);

        setTimeout(() => {
            barItem.querySelector('.horizontal-bar').style.width = `${percentage}%`;
        }, 300);
    });

    chartContainer.appendChild(horizontalBars);
}

function renderPlatformUsageChart(data) {
    const chartContainer = document.getElementById('platformUsageChart');
    chartContainer.innerHTML = '';

    const lineChart = document.createElement('div');
    lineChart.className = 'line-chart';

    const maxValue = Math.max(...data.values, 1);
    const points = data.values.map((value, index) => {
        const x = (index / (data.values.length - 1)) * 500;
        const y = 200 - ((value / maxValue) * 180);
        return `${x},${y}`;
    }).join(' ');

    lineChart.innerHTML = `
        <svg viewBox="0 0 500 200" class="chart">
            <polyline
                fill="none"
                stroke="var(--primary)"
                stroke-width="3"
                points="${points}"
            />
        </svg>
    `;

    chartContainer.appendChild(lineChart);
}

function exportChart(chartId) {
    showToast('info', `Exporting ${chartId} data...`);

    fetch(`/api/admin/analytics/export?chart=${chartId}`)
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${chartId}_export.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('success', 'Export successful');
        })
        .catch(error => {
            console.error('Export error:', error);
            showToast('error', 'Failed to export data');
        });
}

function saveMaxSitesPerUser() {
    const maxSites = document.getElementById('maxSitesPerUser').value;

    if (maxSites < 1 || maxSites > 10) {
        showToast('error', 'Max sites must be between 1 and 10');
        return;
    }

    fetch('/api/admin/settings/max-sites', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ maxSites: parseInt(maxSites) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showToast('success', data.message);
        } else {
            showToast('error', data.error || 'Failed to update max sites setting');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update max sites setting');
    });
}

// Load and save leader access code
function loadLeaderAccessCode() {
    fetch('/api/admin/settings/leader-access-code')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.access_code) {
                document.getElementById('leaderAccessCode').value = data.access_code;
            }
        })
        .catch(error => {
            console.error('Error loading leader access code:', error);
            showToast('error', 'Failed to load leader access code');
        });
}

function saveLeaderAccessCode() {
    const accessCode = document.getElementById('leaderAccessCode').value.trim();
    
    if (!accessCode) {
        showToast('error', 'Access code cannot be empty');
        return;
    }
    
    fetch('/api/admin/settings/leader-access-code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ access_code: accessCode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message || 'Access code updated successfully');
        } else {
            showToast('error', data.message || 'Failed to update access code');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update leader access code');
    });
}

function clearSystemLogs() {
    if (!confirm('Are you sure you want to clear all system logs?')) {
        return;
    }
    
    fetch('/api/admin/logs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'clear' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message || 'Logs cleared successfully');
        } else {
            showToast('error', data.message || 'Failed to clear logs');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to clear logs');
    });
}

function toggleClubLeader(userId, username, isClubLeader) {
    if (!confirm(`Are you sure you want to ${isClubLeader ? 'make' : 'remove'} ${username} ${isClubLeader ? 'a Club Leader' : 'as Club Leader'}?`)) {
        return;
    }

    showToast('info', `${isClubLeader ? 'Making' : 'Removing'} ${username} as club leader...`);

    fetch(`/api/admin/users/${userId}/club-leader`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ is_club_leader: isClubLeader })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        showToast('success', data.message || `Successfully ${isClubLeader ? 'made' : 'removed'} ${username} ${isClubLeader ? 'a' : 'as'} club leader`);
        // Force reload after a short delay to ensure the UI updates
        setTimeout(() => {
            window.location.href = window.location.pathname + '?updated=' + new Date().getTime();
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update club leader status: ' + error.message);
    });
}

</script>

<style>
:root {
    --primary-rgb: 237, 102, 99;
    --primary: #ed6663;
    --primary-dark: #d94642;
    --primary-light: rgba(237, 102, 99, 0.8);
    --accent: #8a64eb;
    --accent-light: #a68eea;
    --danger: #ff4d6d;
    --success: #2ecc71;
    --warning: #ffc107;
    --info: #3498db;
    --surface-primary: #ffffff;
    --surface-secondary: #f8f9fa;
    --background-primary: #f1f3f5;
    --background-secondary: #edf2f7;
    --border-primary: #e2e8f0;
    --border-secondary: #cbd5e0;
    --text-primary: #1a202c;
    --text-secondary: #4a5568;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg:12px;
    --radius-xl: 20px;
}

.admin-container {
    display: flex;
    min-height: 100vh;
    background-color: var(--background-secondary);
    color: var(--text-primary);
    transition: all 0.3s ease;
}

.admin-sidebar {
    width: 260px;
    background-color: var(--surface-primary);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 100;
    transition: all 0.3s ease;
}

.admin-profile {
    padding: 1.5rem;
    display: flex;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 60px;
}

.profile-avatar {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #6e8efb, #a777e3);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.profile-avatar i {
    font-size: 24px;
    color: white;
}

.profile-info h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.admin-badge {
    background-color: var(--primary);
    color: white;
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
    margin-top: 5px;
}

.admin-nav {
    flex: 1;
    padding: 1.5rem 0;
    overflow-y: auto;
}

.admin-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.admin-nav li {
    margin-bottom: 5px;
}

.admin-nav .nav-link {
    display: flex;
    align-items: center;
    padding: 12px 1.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
}

.admin-nav .nav-link i {
    font-size: 18px;
    margin-right: 12px;
    width: 24px;
    text-align: center;
}

.admin-nav .nav-link:hover {
    background-color: rgba(255, 255, 255, 0.05);
    color: var(--text-primary);
}

.admin-nav .nav-link.active {
    background-color: rgba(var(--primary-rgb), 0.1);
    color: var(--primary);
    border-left-color: var(--primary);
}

.admin-sidebar-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
}

.sidebar-collapse-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.sidebar-collapse-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.logout-link {
    color: var(--text-secondary);
    text-decoration: none;
    display: flex;
    align-items: center;
}

.logout-link i {
    margin-right: 8px;
}

.logout-link:hover {
    color: var(--danger);
}

.admin-content {
    flex: 1;
    padding: 2rem;
    margin-left: 260px;
    transition: all 0.3s ease;
}

.admin-header {
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 60px;
}

.admin-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

.admin-header h1 i {
    margin-right: 0.75rem;
    color: var(--primary);
}

.header-actions {
    display: flex;
    gap: 10px;
}

.admin-section {
    background-color: var(--surface-primary);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    display: none;
    animation: fadeIn 0.3s ease;
}

.admin-section.active {
    display: block;
}

.section-header {
    margin-bottom: 1.5rem;
}

.section-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 0.5rem;
    display: flex;
    align-items: center;
}

.section-header h2 i {
    margin-right: 0.75rem;
    color: var(--primary);
}

.section-header p {
    color: var(--text-secondary);
    margin: 0;
}

.section-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.dashboard-stats {
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
}

.stats-wrapper {
    display: flex;
    gap: 1.5rem;
    max-width: 900px;
    flex-wrap: wrap;
    justify-content: center;
}

.stat-card {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.stat-icon i {
    font-size: 24px;
    color: white;
}

.user-icon {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.site-icon {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
}

.visit-icon {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.admin-icon {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
}

.stat-info h3 {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0 0 5px;
}

.statinfo p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.stat-change {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
}

.stat-change.positive {
    color: #2ecc71;
}

.stat-change.negative {
    color: #e74c3c;
}

.stat-change.neutral {
    color: #95a5a6;
}

.stat-change i {
    margin-right: 4px;
}

.dashboard-row {
    display: grid;
    grid-template-columns: 3fr 2fr;
    gap: 1.5rem;
}

.dashboard-card {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.card-header h3 i {
    margin-right: 0.75rem;
    color: var(--primary);
}

.card-actions {
    display: flex;
    gap: 5px;
}

.card-content {
    padding: 1.5rem;
}

.activity-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.activity-item {
    display: flex;
    align-items: flex-start;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-primary);
}

.activity-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.activity-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: rgba(var(--primary-rgb), 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right:1rem;
}

.activity-icon i {
    color: var(--primary);
    font-size: 16px;
}

.activity-details p {
    margin: 0 0 5px;
    font-weight: 500;
}

.activity-time {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-primary);
}

.status-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.status-label {
    font-weight: 500;
}

.status-value {
    font-weight: 500;
    display: flex;
    align-items: center;
}

.status-value i {
    margin-left: 5px;
}

.status-value.healthy {
    color: #2ecc71;
}

.status-value.warning {
    color: #f39c12;
}

.status-value.critical {
    color: #e74c3c;
}

.table-container {
    overflow-x: auto;
    border-radius: 8px;
    background-color: var(--surface-secondary);
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-primary);
}

th {
    background-color: var(--surface-secondary);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

tbody tr {
    transition: background-color 0.2s ease;
}

tbody tr:hover {
    background-color: rgba(var(--primary-rgb), 0.05);
}

.actions-cell {
    width: 180px;
}

.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.action-buttons-cell {
    min-width: 250px;
}

.btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background-color: var(--surface-primary);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background-color: var(--primary);
    color: white;
}

.btn-icon.danger:hover {
    background-color: var(--danger);
}

.btn-primary {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
}

.btn-primary i {
    margin-right: 8px;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
}

.btn-secondary {
    background-color: var(--surface-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.btn-secondary i {
    margin-right: 8px;
}

.btn-secondary:hover {
    background-color: var(--surface-primary);
}

.btn-success {
    background-color: #2ecc71;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.btn-success i {
    margin-right: 8px;
}

.btn-success:hover {
    background-color: #27ae60;
}

.btn-view {
    background-color: #17a2b8;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-view:hover {
    background-color: #138496;
    color: white;
}

.btn-edit {
    background-color: #ffc107;
    color: #212529;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-edit:hover {
    background-color: #e0a800;
    color: #212529;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-danger:hover {
    background-color: #c82333;
}

.btn-warning {
    background-color: #ffc107;
    color: black;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    font-size: 0.9rem;
}

.btn-warning i {
    margin-right: 8px;
}

.btn-warning:hover {
    background-color: #e0a800;
}

.bulk-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.bulk-action {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.bulk-action[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-block;
    margin-right: 5px;
}

.status-badge.active {
    background-color: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
}

.status-badge.suspended {
    background-color: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
}

.status-badge.club-leader {
    background-color: rgba(155, 89, 182, 0.15);
    color: #9b59b6;
}

.type-badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-block;
}

.type-badge.web {
    background-color: rgba(52, 152, 219, 0.15);
    color: #3498db;
}

.type-badge.python {
    background-color: rgba(155, 89, 182, 0.15);
    color: #9b59b6;
}

.site-name {
    display: flex;
    align-items: center;
}

.site-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background-color: rgba(var(--primary-rgb), 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
}

.site-icon i {
    color: var(--primary);
}

.search-container {
    position: relative;
    max-width: 300px;
    width: 100%;
}

.search-input {
    width: 100%;
    padding: 0.65rem 1rem 0.65rem 2.5rem;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    font-size: 0.9rem;
    background-color: var(--surface-secondary);
    color: var(--text-primary);
    transition: all 0.2s ease;
}

.search-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
}

.search-container i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.filter-dropdown {
    position: relative;
}

.filter-btn {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background-color: var(--surface-primary);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    width: 200px;
    z-index: 100;
    display: none;
}

.filter-dropdown:hover .filter-menu {
    display: block;
    animation: slideDown 0.2s ease;
}

.filter-option {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.filter-option:last-child {
    margin-bottom: 0;
}

.filter-option input {
    margin-right: 8px;
}

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 1.5rem;
    gap: 5px;
}

.btn-page {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border-primary);
    background-color: var(--surface-secondary);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-page:hover {
    background-color: var(--primary);
    color: white;
    border-color: var(--primary);
}

.btn-page.active {
    background-color: var(--primary);
    color: white;
    border-color: var(--primary);
}

.pagination-ellipsis {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
}

.admin-management {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.admin-list-container, .add-admin-form {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.admin-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 400px;
    overflow-y: auto;
}

.admin-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-primary);
    transition: background-color 0.2s ease;
}

.admin-item:hover {
    background-color: rgba(var(--primary-rgb), 0.05);
}

.admin-item:last-child {
    border-bottom: none;
}

.admin-info {
    display: flex;
    flex-direction: column;
}

.admin-name {
    font-weight: 500;
    margin-bottom: 4px;
}

.admin-email {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.remove-admin {
    color: #dc3545;
}

.remove-admin:hover {
    background-color: rgba(220, 53, 69, 0.1);
}

.remove-admin[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
}

.admin-list-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(var(--primary-rgb), 0.3);
    border-top-color: var(--primary);
    border-radius: 50%;
    margin-right: 10px;
    animation: spin 1s linear infinite;
}

.form-content {
    padding: 1.5rem;
}

.form-content p {
    margin-top: 0;
    color: var(--text-secondary);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group label i {
    margin-right: 8px;
    color: var(--primary);
}

.input-with-icon {
    position: relative;
}

.input-with-icon i {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.admin-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    font-size: 0.9rem;
    background-color: var(--surface-primary);
    color: var(--text-primary);
    transition: all 0.2s ease;
}

.admin-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
}

.permission-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.permission-option {
    display: flex;
    align-items: center;
}

.permission-option input {
    margin-right: 8px;
}

.add-admin-btn {
    margin-top: 1rem;
    width: 100%;
}

.analytics-timeframe {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1.5rem;
    background-color: var(--surface-secondary);
    padding: 0.5rem;
    border-radius: 8px;
    width: fit-content;
}

.time-btn {
    padding: 0.5rem 1rem;
    background-color: transparent;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.time-btn.active {
    background-color: var(--primary);
    color: white;
}

.date-picker {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;background-color: transparent;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 10px;
    border-left: 1px solid var(--border-primary);
}

.date-picker i {
    margin-right: 8px;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.analytics-card {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.analytics-card.wide {
    grid-column: span 2;
}

.chart-container {
    padding: 1.5rem;
    height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
}

.chart-bars {
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    width: 100%;
    height: 100%;
}

.chart-bar {
    width: 8%;
    background: linear-gradient(to top, var(--primary), var(--primary-light));
    border-radius: 6px 6px 0 0;
    transition: height 1s ease;
}

.line-chart {
    width: 100%;
    height: 100%;
}

.chart svg {
    width: 100%;
    height: 100%;
}

.pie-chart {
    position: relative;
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background-color: var(--accent);
    overflow: hidden;
}

.pie-segment {
    position: absolute;
    width: 100%;
    height: 100%;
    transform-origin: 50% 50%;
    transition: transform 1s ease;
}

.pie-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--surface-secondary);
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
}

.chart-legend {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-left: 1.5rem;
}

.legend-item {
    display: flex;
    align-items: center;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    margin-right: 8px;
}

.horizontal-bars {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.horizontal-bar-item {
    display: flex;
    align-items: center;
}

.bar-label {
    width: 60px;
}

.bar-container {
    flex: 1;
    height: 10px;
    background-color: rgba(var(--primary-rgb), 0.1);
    border-radius: 10px;
    margin: 0 10px;
    overflow: hidden;
}

.horizontal-bar {
    height: 100%;
    background-color: var(--primary);
    border-radius: 10px;
    transition: width 1s ease;
}

.bar-value {
    width: 40px;
    text-align: right;
    font-weight: 500;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
    gap: 1.5rem;
}

.settings-container {
    max-width: 600px;
    margin: 0 auto 1.5rem;
}

.settings-card {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.settings-form {
    padding: 1.5rem;
}

.toggle-option {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.toggle-option:last-child {
    margin-bottom: 0;
}

.toggle-label {
    font-weight: 500;
}

.switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: var(--primary);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--primary);
}

input:checked + .slider:before {
    transform: translateX(24px);
}

.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}

.settings-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    background-color: var(--surface-primary);
    color: var(--text-primary);
    appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23718096" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>');
    background-repeat: no-repeat;
    background-position: right 1rem center;
}

.settings-input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    background-color: var(--surface-primary);
    color: var(--text-primary);
}

.input-group {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 5px 0;
}

.input-label {
    flex: 0 0 auto;
    margin-right: 15px;
}

.number-input {
    width: 80px;
    padding: 0.5rem;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    background-color: var(--surface-primary);
    color: var(--text-primary);
    text-align: center;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 1rem;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    animation: fadeIn 0.3s ease;
    overflow-y: auto;
    padding: 20px;
}

.modal.show,
.modal[style*="display: flex"] {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background-color: white;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.modal-header h2 i {
    margin-right: 10px;
    color: var(--primary);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.2s ease;
}

.close-btn:hover {
    color: var(--danger);
}

.modal-body {
    padding: 1.5rem;
}

.modal-actions {
    padding: 1.5rem;
    border-top: 1px solid var(--border-primary);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.modal {
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease;
}

.user-info-container {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
}

.user-avatar {
    width: 80px;
    height: 80px;
    background-color: var(--surface-secondary);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.user-avatar i {
    font-size: 40px;
    color: var(--primary);
}

.user-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin: 0 auto;
}

.user-details h3 {
    margin: 0 0 10px;
    font-size: 1.5rem;
    font-weight: 600;
}

.user-meta {
    margin-bottom: 1.5rem;
}

.user-meta p {
    margin: 8px 0;
    display: flex;
    align-items: center;
}

.user-meta p i {
    width: 20px;
    margin-right: 10px;
    color: var(--text-secondary);
}

.user-stats {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: var(--surface-secondary);
    padding: 1rem;
    border-radius: 8px;
    flex: 1;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.user-actions {
    display: flex;
    gap: 10px;
}

.user-detail-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.error-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: var(--danger);
    padding: 2rem;
}

.error-message i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    background-color: var(--surface-primary);
    border-radius: 8px;
    padding: 1rem;
    min-width: 300px;
    max-width: 400px;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateX(120%);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success {
    border-left: 4px solid #2ecc71;
}

.toast.error {
    border-left: 4px solid #e74c3c;
}

.toast.info {
    border-left: 4px solid #3498db;
}

.toast i {
    font-size: 1.25rem;
    margin-right: 10px;
}

.toast.success i {
    color: #2ecc71;
}

.toast.error i {
    color: #e74c3c;
}

.toast.info i {
    color: #3498db;
}

.toast span {
    flex: 1;
}

.toast-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: color 0.2s ease;
}

.toast-close:hover {
    color: var(--danger);
}

.user-management-stats {
    margin-bottom: 24px;
    justify-content: flex-start;
}

.user-table-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.user-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--surface-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.user-avatar-small img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-avatar-small i {
    font-size: 16px;
    color: var(--text-secondary);
}

.status-badge.admin {
    background-color: rgba(52, 152, 219, 0.15);
    color: #3498db;
    border: 1px solid rgba(52, 152, 219, 0.3);
}

.status-badge.public-profile {
    background-color: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
    border: 1px solid rgba(46, 204, 113, 0.3);
}

.status-badge.staff-badge {
    background-color: rgba(255, 140, 55, 0.15);
    color: #ff8c37;
    border: 1px solid rgba(255, 140, 55, 0.3);
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 24px;
    -webkit-appearance: none;
    background-color: #ccc;
    outline: none;
    border-radius: 20px;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
    transition: 0.3s;
    cursor: pointer;
}

.toggle-switch:checked {
    background-color: var(--primary);
}

.toggle-switch:before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 20px;
    top: 2px;
    left: 2px;
    background-color: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    transition: 0.3s;
}

.toggle-switch:checked:before {
    left: 28px;
}

.form-switch {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}

.wide-modal .modal-content {
    max-width: 900px;
    width: 90%;
}

.profile-edit-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

.profile-preview {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.profile-preview-card {
    background-color: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.preview-banner {
    height: 100px;
    background-color: var(--primary-light);
    background-size: cover;
    background-position: center;
    position: relative;
}

.preview-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background-color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    bottom: -32px;
    left: 24px;
    border: 3px solid white;
    overflow: hidden;
}

.preview-avatar i {
    font-size: 32px;
    color: var(--text-secondary);
}

.preview-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.preview-content {
    padding: 40px 24px 24px;
}

.preview-content h3 {
    margin-bottom: 12px;
}

.social-links-section {
    background-color: var(--surface-secondary);
    border-radius: 12px;
    padding: 20px;
}

.social-links-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
}

.social-link-item {
    display: flex;
    gap: 8px;
    align-items: center;
}

.social-platform {
    flex: 1;
}

.social-url {
    flex: 2;
}

.password-strength-meter {
    margin-top: 10px;
}

.strength-bar {
    height: 8px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 5px;
}

.strength-indicator {
    height: 100%;
    width: 0;
    transition: width 0.3s, background-color 0.3s;
    border-radius: 4px;
}

#strengthText {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .profile-edit-grid {
        grid-template-columns: 1fr;
    }
}

.sidebar-collapsed .admin-sidebar {
    width: 80px;
}

.sidebar-collapsed .admin-content {
    margin-left: 80px;
}

.sidebar-collapsed .profile-info,
.sidebar-collapsed .nav-link span,
.sidebar-collapsed .logout-link span {
    display: none;
}

.sidebar-collapsed .sidebar-collapse-btn i {
    transform: rotate(180deg);
}

.sidebar-collapsed .admin-nav .nav-link {
    justify-content: center;
    padding: 12px 0;
}

.sidebar-collapsed .admin-nav .nav-link i {
    margin-right: 0;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes slideDown {
    from {
        transform: translateY(-10px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.fade-in {
    animation: fadeIn 0.3s ease;
}

.section-entrance {
    animation: slideUp 0.5s ease;
}

/* Action Dropdown Styling */
.action-dropdown {
    position: relative;
    display: inline-block;
}

.action-dropdown-btn {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    background-color: var(--surface-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.action-dropdown-btn:hover {
    background-color: var(--background-primary);
    color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.action-dropdown-content {
    position: fixed;
    background-color: var(--surface-primary);
    min-width: 180px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.action-dropdown {
    position: relative;
}

/* Action dropdown now works on click instead of hover */
.action-dropdown-content.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: all 0.2s ease;
    text-decoration: none;
}

.dropdown-item:hover {
    background-color: var(--background-primary);
}

.dropdown-item i {
    width: 20px;
    margin-right: 10px;
    font-size: 0.9rem;
}

.dropdown-item.text-danger {
    color: var(--danger);
}

.dropdown-item.text-danger:hover {
    background-color: rgba(255, 77, 109, 0.1);
}

/* Table Styling Improvements */
.table-container {
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

table {
    border-collapse: separate;
    border-spacing: 0;
}

th {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 1.25rem 1rem;
    background-color: var(--surface-primary);
    border-bottom: 2px solid var(--border-primary);
}

td {
    vertical-align: middle;
    padding: 1rem;
    border-bottom: 1px solid var(--border-primary);
}

tbody tr:last-child td {
    border-bottom: none;
}

tbody tr {
    transition: all 0.2s ease;
}

tbody tr:hover {
    background-color: rgba(var(--primary-rgb), 0.05);
}

/* Status Badge Enhancements */
.status-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 30px;
    display: inline-flex;
    align-items: center;
    line-height: 1;
}

.status-badge.active {
    background-color: rgba(46, 204, 113, 0.15);
    color: var(--success);
    border: 1px solid rgba(46, 204, 113, 0.3);
}

.status-badge.suspended {
    background-color: rgba(255, 77, 109, 0.15);
    color: var(--danger);
    border: 1px solid rgba(255, 77, 109, 0.3);
}

.status-badge.club-leader {
    background-color: rgba(138, 100, 235, 0.15);
    color: var(--accent);
    border: 1px solid rgba(138, 100, 235, 0.3);
}

/* Card Improvements */
.dashboard-card, .analytics-card, .settings-card {
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    background-color: var(--surface-primary);
    transition: all 0.3s ease;
}

.dashboard-card:hover, .analytics-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.card-header {
    padding: 1.25rem;
    border-bottom: 1px solid var(--border-primary);
    background-color: var(--surface-primary);
}

.card-content {
    padding: 1.5rem;
}

/* Stats Card Improvements */
.stat-card {
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    background: var(--surface-primary);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-md);
    margin-right: 1.25rem;
}

.user-icon {
    background: linear-gradient(135deg, var(--info), #2574a9);
}

.site-icon {
    background: linear-gradient(135deg, var(--success), #27ae60);
}

.admin-icon {
    background: linear-gradient(135deg, var(--accent), #6c5ce7);
}

/* Button Enhancements */
.btn-primary, .btn-secondary, .btn-danger, .btn-success, .btn-warning {
    border-radius: var(--radius-md);
    padding: 0.75rem 1.25rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    gap: 8px;
    font-size: 0.95rem;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background-color: var(--surface-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-primary);
}

.btn-secondary:hover {
    background-color: var(--background-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.btn-danger {
    background-color: var(--danger);
    color: white;
}

.btn-danger:hover {
    background-color: #ff3358;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background-color: var(--success);
    color: white;
}

.btn-success:hover {
    background-color: #27ae60;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Admin Sidebar Improvements */
.admin-sidebar {
    background: linear-gradient(to bottom, var(--surface-primary), #f5f7fa);
    border-right: 1px solid var(--border-primary);
    box-shadow: var(--shadow-md);
    width: 280px;
}

.profile-avatar {
    width: 55px;
    height: 55px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: var(--radius-md);
}

.admin-nav .nav-link {
    border-radius: var(--radius-md);
    margin: 0 1rem;
    padding: 12px 1rem;
}

.admin-nav .nav-link.active {
    background-color: rgba(var(--primary-rgb), 0.1);
    color: var(--primary);
    font-weight: 600;
}

.admin-nav .nav-link:hover {
    background-color: var(--background-primary);
}

/* Pagination Improvements */
.pagination {
    margin-top: 2rem;
    gap: 8px;
}

.btn-page {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    background-color: var(--surface-primary);
    border: 1px solid var(--border-primary);
    transition: all 0.2s ease;
}

.btn-page.active, .btn-page:hover {
    background-color: var(--primary);
    color: white;
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

/* Form Element Improvements */
.search-input, .admin-input, .form-input, .form-textarea {
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-primary);
    transition: all 0.2s ease;
    background-color: var(--surface-primary);
}

.search-input:focus, .admin-input:focus, .form-input:focus, .form-textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
    outline: none;
}

/* Toast Improvements */
.toast-container {
    z-index: 9999;
}

.toast {
    box-shadow: var(--shadow-lg);
    border-radius: var(--radius-md);
    min-width: 300px;
}

.toast.success {
    border-left: 4px solid var(--success);
}

.toast.error {
    border-left: 4px solid var(--danger);
}

.toast.info {
    border-left: 4px solid var(--info);
}

.toast.warning {
    border-left: 4px solid var(--warning);
}

/* Modal Improvements */
.modal {
    backdrop-filter: blur(5px);
}

.modal-content {
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: none;
}

.modal-header {
    background-color: var(--surface-primary);
}

.modal-actions {
    background-color: var(--surface-secondary);
}

/* Custom animations */
@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.5);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0);
    }
}

.user-edit-container {
    margin-top: 2rem;
    border-top: 1px solid var(--border-primary);
    padding-top: 1.5rem;
}

.password-input-group {
    position: relative;
}

.toggle-password {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
}

/* Media Queries */
@media (max-width: 992px) {
    .admin-container {
        flex-direction: column;
    }

    .admin-sidebar {
        width: 100%;
        position: relative;
        box-shadow: none;
        border-bottom: 1px solid var(--border-primary);
    }

    .admin-content {
        margin-left: 0;
    }

    .admin-nav ul {
        display: flex;
        flex-wrap: wrap;
    }

    .admin-nav li {
        margin-right: 10px;
    }

    .admin-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .header-actions {
        margin-top: 1rem;
    }

    .dashboard-row,
    .admin-management {
        grid-template-columns: 1fr;
    }

    .analytics-grid {
        grid-template-columns: 1fr;
    }

    .analytics-card.wide {
        grid-column: auto;
    }

    .settings-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .admin-content {
        padding: 1rem;
    }

    .dashboard-stats {
        grid-template-columns: 1fr;
    }

    .section-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .bulk-actions {
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }

    .action-buttons-cell {
        min-width: 200px;
    }

    .analytics-timeframe {
        overflow-x: auto;
        width: 100%;
    }
}

@media (max-width: 576px) {
    .admin-header h1 {
        font-size: 1.5rem;
    }

    .table-container {
        margin: 0 -1rem;
        width: calc(100% + 2rem);
        border-radius: 0;
    }

    .user-info-container {
        flex-direction: column;
    }

    .user-avatar {
        margin: 0 auto 1rem;
    }

    .user-actions {
        flex-direction: column;
    }

    .user-actions button {
        width: 100%;
    }

    .toast {
        min-width: auto;
        max-width: 300px;
    }
}
/* User detail card improvements */
.user-info-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    margin: 0 auto;
    max-width: 500px;
    padding: 1.5rem;
    background-color: var(--surface-secondary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
}

.user-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--surface-primary);
    border: 5px solid var(--primary);
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-avatar i {
    font-size: 60px !important;
    color: var(--primary);
}

.user-meta {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 1.5rem;
    width: 100%;
}

.user-meta p {
    margin: 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1rem;
}

.user-stats {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
}

.stat-item {
    flex: 1;
    min-width: 120px;
    background-color: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: 1rem;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
}

.stat-item:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
    border-color: var(--primary);
}

.user-actions {
    display: flex;
    gap: 10px;
    margin-top: 1rem;
    justify-content: center;
}

/* Action modal styles */
.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    width: 100%;
}

.action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    background-color: var(--surface-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--text-primary);
    transition: all 0.2s ease;
    gap: 0.5rem;
    cursor: pointer;
}

.action-btn i {
    font-size: 1.5rem;
    color: var(--primary);
}

.action-btn:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
    background-color: var(--surface-tertiary);
    border-color: var(--primary);
}

.action-btn.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.action-btn.disabled:hover {
    transform: none;
    box-shadow: none;
    background-color: var(--surface-secondary);
    border-color: var(--border-primary);
}

.success-action i {
    color: var(--success);
}

.danger-action i {
    color: var(--danger);
}

.success-action:hover {
    border-color: var(--success);
}

.danger-action:hover {
    border-color: var(--danger);
}
</style>
{% endblock %}